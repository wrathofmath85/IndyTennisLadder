<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Indy Tennis Ladder – Round 1 Score Entry</title>
<style>
  :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  body { margin: 24px; max-width: 1000px; }
  h1 { margin: 0 0 12px; }
  fieldset { border: 1px solid #ccc; border-radius: 8px; padding: 16px; margin: 16px 0; }
  legend { font-weight: 600; }
  label { display: block; margin: 8px 0 4px; }
  input[type="number"] { width: 80px; padding: 6px; }
  input[readonly] { background: #f8f8f8; }
  select { padding: 6px; min-width: 320px; }
  .row { display: grid; grid-template-columns: 180px 1fr; gap: 12px; align-items: center; }
  .muted { color: #666; font-size: 0.92rem; }
  .inline { display:inline-flex; gap:10px; align-items:center; }
  .chip { border:1px solid #bbb; border-radius:999px; padding:6px 10px; cursor:pointer; user-select:none; }
  .chip.active { background:#222; color:#fff; border-color:#222; }
  .error { color:#b00020; margin-top: 8px; }
  .success { color:#0a7a2f; margin-top: 8px; }
  button { padding: 10px 16px; border-radius: 8px; border: 1px solid #222; background: #222; color: #fff; cursor: pointer; }
  button[disabled] { opacity: 0.5; cursor: not-allowed; }
  hr { border: none; border-top: 1px solid #ddd; margin: 16px 0; }

  /* rotated score grid: rows=players, columns=sets */
  .scoregrid {
    display: grid;
    grid-template-columns: 180px repeat(3, 170px) 220px; /* Name | Set1 | Set2 | Set3 | Match TB (hidden unless in TB mode) */
    gap: 8px;
    align-items: center;
  }
  .scoregrid .th { font-weight: 600; text-align: center; }
  .scoregrid .rowlabel { font-weight: 600; }
  .col-mtb { display: none; } /* only when match TB is on */
  .tb-note { font-size: 0.85rem; color:#666; margin-top:4px; }
  .setcell { display:flex; flex-direction:column; align-items:center; gap:6px; }
  .setcell .tbwrap { display:none; }
</style>
</head>
<body>
  <h1>Round 1 Score Submission</h1>
  <p class="muted">Pick the winner, we’ll auto-fill the opponent based on Round 1 pairings. Third set can be a full set or a 10‑point match tiebreak.</p>

  <fieldset>
    <legend>Players</legend>
    <div class="row">
      <label for="winner">Winner</label>
      <select id="winner" required>
        <option value="">Loading players…</option>
      </select>
    </div>
    <div class="row">
      <label for="opponent">Opponent</label>
      <input id="opponent" type="text" readonly placeholder="Will auto-fill after you pick a winner" />
    </div>
  </fieldset>

  <fieldset>
    <legend>Scores</legend>
    <div class="inline" style="margin-bottom:8px;">
      <span class="muted">Match status:</span>
      <span id="chip-completed" class="chip active" data-status="Completed" role="button" tabindex="0">Completed</span>
      <span id="chip-retired" class="chip" data-status="Retired" role="button" tabindex="0">Retired</span>
      <span id="chip-walkover" class="chip" data-status="Walkover" role="button" tabindex="0">Walkover</span>
    </div>

    <div class="inline" style="margin-bottom:12px;">
      <label class="inline">
        <input id="isTb" type="checkbox" /> Use 10‑point <b>match</b> tiebreak instead of full third set
      </label>
      <span class="tb-note">If any set is 7–6, a small “TB (winner pts)” box will appear for that set.</span>
    </div>

    <!-- Rotated grid -->
    <div class="scoregrid" aria-label="Set scores">
      <div></div>
      <div class="th">Set 1</div>
      <div class="th">Set 2</div>
      <div class="th col-s3">Set 3</div>
      <div class="th col-mtb" id="mtbHdr">Match TB (to 10)</div>

      <div class="rowlabel" id="winnerLabel">Winner</div>

      <div class="setcell">
        <div><input id="s1w" type="number" min="0" max="7" inputmode="numeric" aria-label="Winner Set 1" /></div>
        <div class="tbwrap" id="s1tb_wrap"><label class="muted">TB (winner pts)</label><input id="s1tb" type="number" min="0" inputmode="numeric" /></div>
      </div>

      <div class="setcell">
        <div><input id="s2w" type="number" min="0" max="7" inputmode="numeric" aria-label="Winner Set 2" /></div>
        <div class="tbwrap" id="s2tb_wrap"><label class="muted">TB (winner pts)</label><input id="s2tb" type="number" min="0" inputmode="numeric" /></div>
      </div>

      <div class="setcell col-s3">
        <div><input id="s3w" type="number" min="0" max="7" inputmode="numeric" aria-label="Winner Set 3" /></div>
        <div class="tbwrap" id="s3tb_wrap"><label class="muted">TB (winner pts)</label><input id="s3tb" type="number" min="0" inputmode="numeric" /></div>
      </div>

      <div class="setcell col-mtb">
        <div><input id="tbw" type="number" min="0" inputmode="numeric" placeholder="Winner TB" /></div>
      </div>

      <div class="rowlabel" id="opponentLabel">Opponent</div>

      <div class="setcell">
        <div><input id="s1o" type="number" min="0" max="7" inputmode="numeric" aria-label="Opponent Set 1" /></div>
      </div>

      <div class="setcell">
        <div><input id="s2o" type="number" min="0" max="7" inputmode="numeric" aria-label="Opponent Set 2" /></div>
      </div>

      <div class="setcell col-s3">
        <div><input id="s3o" type="number" min="0" max="7" inputmode="numeric" aria-label="Opponent Set 3" /></div>
      </div>

      <div class="setcell col-mtb">
        <div><input id="tbo" type="number" min="0" inputmode="numeric" placeholder="Opponent TB" /></div>
      </div>
    </div>

    <div id="msg" class="error" role="alert" aria-live="polite"></div>
  </fieldset>

  <div class="inline">
    <button id="submitBtn" disabled>Submit score</button>
    <span id="ok" class="success" style="display:none;">Submitted. Thanks!</span>
  </div>

<script>
/*** ======= CONFIG: add your URLs here ======= ***/
const PLAYERS_CSV_URL  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=0&single=true&output=csv';
const SCHEDULE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1596015267&single=true&output=csv';
const SUBMIT_ENDPOINT  = 'https://script.google.com/macros/s/AKfycbxKmvlinT_xPRc5pHohySSYs5EKtEU4GCgfKNL1aE3OBJ6mgCu6gFSae27R_H6if9-9/exec';
/*** =========================================== ***/

// state
let players = [];
let nameByRank = new Map();
let rankByName = new Map();
let scheduleR1 = new Map();
let status = 'Completed';

// CSV parser
function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  const headers = lines[0].split(',').map(s => s.trim());
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(',').map(s => s.trim());
    const obj = {};
    headers.forEach((h, idx) => obj[h] = cols[idx] ?? '');
    rows.push(obj);
  }
  return { headers, rows };
}

function lastNameOf(full) {
  if (!full) return '';
  const parts = full.trim().split(/\s+/);
  return parts[parts.length - 1].replace(/[.,]/g, '');
}

async function loadPlayers() {
  const res = await fetch(PLAYERS_CSV_URL, { cache: 'no-store' });
  const text = await res.text();
  const { rows } = parseCSV(text);
  const norm = k => k.toLowerCase();

  const mapped = rows.map(r => {
    const m = new Map(Object.entries(r).map(([k,v]) => [norm(k), v]));
    return {
      name: m.get('participant') || m.get('name') || '',
      roundStart: Number(m.get('roundstart') || m.get('round start') || 0),
      roundEnd: Number(m.get('roundend') || m.get('round end') || 0),
      p: Number(m.get('round1points') || m.get('round 1 points') || 0),
      pct: Number(m.get('round1percent') || m.get('round 1 percent') || 0),
    };
  }).filter(p => p.name);

  const eligible = mapped.filter(p => p.roundStart <= 1 && p.roundEnd >= 1);

  eligible.sort((a, b) => {
    if (b.p !== a.p) return b.p - a.p;
    if (b.pct !== a.pct) return b.pct - a.pct;
    const la = lastNameOf(a.name).toLowerCase();
    const lb = lastNameOf(b.name).toLowerCase();
    if (la < lb) return -1;
    if (la > lb) return 1;
    return a.name.localeCompare(b.name);
  });

  players = eligible;
  nameByRank.clear(); rankByName.clear();
  eligible.forEach((p, idx) => {
    const rank = idx + 1;
    nameByRank.set(rank, p.name);
    rankByName.set(p.name, rank);
  });

  // dropdown: show "[rank] Name" but keep value = Name
  const sel = document.getElementById('winner');
  const names = [...eligible.map(p => p.name)].sort((a,b) => a.localeCompare(b));
  sel.innerHTML = '<option value="">Select winner…</option>' + names.map(n => {
    const rank = rankByName.get(n);
    return `<option value="${n}">[${rank}] ${n}</option>`;
  }).join('');
}

async function loadScheduleR1() {
  const res = await fetch(SCHEDULE_CSV_URL, { cache: 'no-store' });
  const text = await res.text();
  const { headers, rows } = parseCSV(text);
  const idxRanking = headers.findIndex(h => h.trim().toLowerCase() === 'ranking');
  const idxR1 = headers.findIndex(h => h.trim().toLowerCase() === 'round 1' || h.trim().toLowerCase() === 'round1');
  if (idxRanking === -1 || idxR1 === -1) throw new Error('Schedule CSV must have headers "Ranking" and "Round 1"');

  scheduleR1.clear();
  rows.forEach(r => {
    const rank = Number(Object.values(r)[idxRanking]);
    const opp = Number(Object.values(r)[idxR1]);
    if (!Number.isNaN(rank) && !Number.isNaN(opp)) scheduleR1.set(rank, opp);
  });
}

function setStatusChip(newStatus) {
  status = newStatus;
  for (const id of ['chip-completed', 'chip-retired', 'chip-walkover']) {
    const el = document.getElementById(id);
    if (el.dataset.status === newStatus) el.classList.add('active'); else el.classList.remove('active');
  }
  const disabled = (newStatus === 'Walkover');
  ['s1w','s1o','s2w','s2o','s3w','s3o','tbw','tbo','isTb','s1tb','s2tb','s3tb'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.disabled = disabled;
  });
  document.getElementById('msg').textContent = '';
}

function showSetTBIfNeeded(setIdx) {
  const w = Number(document.getElementById(`s${setIdx}w`).value);
  const o = Number(document.getElementById(`s${setIdx}o`).value);
  const wrap = document.getElementById(`s${setIdx}tb_wrap`);
  if (!wrap) return;
  const is76 = ( (w === 7 && o === 6) || (w === 6 && o === 7) );
  wrap.style.display = is76 ? 'flex' : 'none';
  if (!is76) document.getElementById(`s${setIdx}tb`).value = '';
}

function toggleTBUI(isTB) {
  // toggle columns for Set 3 vs Match TB
  document.querySelectorAll('.col-s3').forEach(el => el.style.display = isTB ? 'none' : '');
  document.querySelectorAll('.col-mtb').forEach(el => el.style.display = isTB ? '' : 'none');
}

function updateRowLabels() {
  const w = document.getElementById('winner').value || 'Winner';
  const o = document.getElementById('opponent').value || 'Opponent';
  document.getElementById('winnerLabel').textContent = w;
  document.getElementById('opponentLabel').textContent = o;
}

function computeOpponent() {
  const winner = document.getElementById('winner').value;
  const out = document.getElementById('opponent');
  out.value = '';
  if (!winner) { updateRowLabels(); return; }

  const r = rankByName.get(winner);
  if (!r) { out.value = 'Rank not found'; updateRowLabels(); return; }

  const oppRank = scheduleR1.get(r);
  if (!oppRank) { out.value = 'No Round 1 opponent found'; updateRowLabels(); return; }

  const oppName = nameByRank.get(oppRank) || '(rank exists but player not in eligible list)';
  out.value = oppName || '';
  updateRowLabels();
}

function readInt(id) {
  const el = document.getElementById(id);
  if (!el) return null;
  const v = el.value.trim();
  return v === '' ? null : Number(v);
}

function validateScores() {
  const msg = document.getElementById('msg');
  msg.textContent = '';
  if (status === 'Walkover') return true;

  const isTB = document.getElementById('isTb').checked;

  const s1w = readInt('s1w'), s1o = readInt('s1o'), s1tb = readInt('s1tb');
  const s2w = readInt('s2w'), s2o = readInt('s2o'), s2tb = readInt('s2tb');
  const s3w = readInt('s3w'), s3o = readInt('s3o'), s3tb = readInt('s3tb');
  const tbw = readInt('tbw'), tbo = readInt('tbo');

  const haveS1 = s1w !== null && s1o !== null;
  const haveS2 = s2w !== null && s2o !== null;

  if (status === 'Retired') {
    if (!(haveS1 || haveS2 || s3w !== null || s3o !== null || tbw !== null || tbo !== null)) {
      msg.textContent = 'Please enter whatever score progress existed before retirement.';
      return false;
    }
    return true;
  }

  if (!haveS1 || !haveS2) {
    msg.textContent = 'Enter Set 1 and Set 2 scores.';
    return false;
  }

  // require TB fields when a set is 7–6
  const needTB1 = ( (s1w===7&&s1o===6) || (s1w===6&&s1o===7) );
  if (needTB1 && s1tb === null) { msg.textContent = 'Enter TB (winner pts) for Set 1.'; return false; }
  const needTB2 = ( (s2w===7&&s2o===6) || (s2w===6&&s2o===7) );
  if (needTB2 && s2tb === null) { msg.textContent = 'Enter TB (winner pts) for Set 2.'; return false; }

  const winSet = (a, b) => a !== null && b !== null && a > b;
  let setsWon = 0, setsLost = 0;
  if (winSet(s1w, s1o)) setsWon++; else setsLost++;
  if (winSet(s2w, s2o)) setsWon++; else setsLost++;

  if (setsWon === 2) return true;

  if (setsWon === 1 && setsLost === 1) {
    if (isTB) {
      if (tbw === null || tbo === null) { msg.textContent = 'Enter the match tiebreak score.'; return false; }
      if (tbw < 10 || tbw - tbo < 2) { msg.textContent = 'Match tiebreak must be at least 10 and win by 2 for the winner.'; return false; }
      return true;
    } else {
      if (s3w === null || s3o === null) { msg.textContent = 'Enter Set 3 score or choose “match tiebreak”.'; return false; }
      const needTB3 = ( (s3w===7&&s3o===6) || (s3w===6&&s3o===7) );
      if (needTB3 && s3tb === null) { msg.textContent = 'Enter TB (winner pts) for Set 3.'; return false; }
      if (!(s3w > s3o)) { msg.textContent = 'Winner must win Set 3.'; return false; }
      return true;
    }
  }

  msg.textContent = 'Scores must reflect the selected winner.';
  return false;
}

async function submitForm() {
  const btn = document.getElementById('submitBtn');
  const ok = document.getElementById('ok');
  const msg = document.getElementById('msg');
  msg.textContent = ''; ok.style.display = 'none';

  const winner = document.getElementById('winner').value;
  const opponent = document.getElementById('opponent').value;
  if (!winner) { msg.textContent = 'Pick a winner.'; return; }
  if (!opponent) { msg.textContent = 'Opponent not found yet. Double‑check schedule/players CSV.'; return; }
  if (!validateScores()) return;

  const payload = {
    timestamp: new Date().toISOString(),
    round: 1,
    winner,
    opponent,
    winnerRank: rankByName.get(winner) || null,
    opponentRank: scheduleR1.get(rankByName.get(winner)) || null,
    status,
    isTiebreakThird: document.getElementById('isTb').checked,
    s1w: readInt('s1w'), s1o: readInt('s1o'), s1tb: readInt('s1tb'),
    s2w: readInt('s2w'), s2o: readInt('s2o'), s2tb: readInt('s2tb'),
    s3w: readInt('s3w'), s3o: readInt('s3o'), s3tb: readInt('s3tb'),
    tbw: readInt('tbw'), tbo: readInt('tbo')
  };

  btn.disabled = true;
  try {
    await fetch(SUBMIT_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload),
      mode: 'no-cors'
    });

    // request sent; treat as success
    ok.style.display = 'inline';
    ['s1w','s1o','s2w','s2o','s3w','s3o','tbw','tbo','s1tb','s2tb','s3tb'].forEach(id=>{ const el=document.getElementById(id); if (el) el.value=''; });
    msg.textContent = '';
  } catch (e) {
    msg.textContent = 'Could not submit: ' + e.message;
  } finally {
    btn.disabled = false;
  }
}

/*** wiring ***/
document.getElementById('isTb').addEventListener('change', (e)=>toggleTBUI(e.target.checked));
['chip-completed','chip-retired','chip-walkover'].forEach(id => {
  document.getElementById(id).addEventListener('click', e => setStatusChip(e.target.dataset.status));
});
['s1w','s1o','s2w','s2o','s3w','s3o'].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener('input', () => {
    const setIdx = id[1]; // '1','2','3'
    showSetTBIfNeeded(setIdx);
  });
});
document.getElementById('winner').addEventListener('change', computeOpponent);
document.getElementById('submitBtn').addEventListener('click', submitForm);

// init
(async function init(){
  try {
    await Promise.all([loadPlayers(), loadScheduleR1()]);
    computeOpponent();
    updateRowLabels();
    toggleTBUI(false);
    setStatusChip('Completed');
    document.getElementById('submitBtn').disabled = false;
  } catch (e) {
    document.getElementById('msg').textContent = 'Setup error: ' + e.message;
  }
})();
</script>
</body>
</html>
