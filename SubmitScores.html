<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Indy Tennis Ladder – Round 1 Score Entry</title>
<style>
  :root{
    --bg:#0b0e14;
    --card:#11161f;
    --muted:#8ea0b4;
    --text:#e9eef5;
    --line:#253043;
    --accent:#5dd0ff;
    --accent-ink:#052c3a;
    --success:#3bd37f;
    --danger:#ff6b6b;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }
  html,body{background:linear-gradient(180deg,#0b0e14, #0b0e14 180px, #0d121b 100%); color:var(--text);}
  body{ margin:24px; display:flex; justify-content:center; }
  .wrap{ width:min(1100px,100%); }

  header{
    padding:20px 16px;
    border-radius:14px;
    background:
      radial-gradient(1200px 400px at 20% -80%, rgba(93,208,255,.10), transparent 60%),
      linear-gradient(180deg, rgba(93,208,255,.07), rgba(93,208,255,0));
    border:1px solid var(--line);
    margin-bottom:16px;
  }
  h1{ margin:0 0 6px; font-size:1.5rem; letter-spacing:.2px;}
  .muted{ color:var(--muted); font-size:.95rem; }

  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    padding:16px;
    margin:16px 0;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
  }
  legend{ font-weight:700; padding:0 6px; }
  fieldset{ border: none; margin:0; padding:0; }

  label{ display:block; margin:8px 0 6px; font-weight:600; }
  select, input[type="number"], input[type="text"]{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid var(--line);
    background:#0e1420;
    color:var(--text);
    outline:none;
  }
  input[readonly]{ opacity:.8; }

  .grid{
    display:grid; gap:14px;
    grid-template-columns: 220px 1fr;
    align-items:center;
  }
  @media (max-width:700px){ .grid{ grid-template-columns: 1fr; } }

  .chips{ display:flex; gap:8px; flex-wrap:wrap; }
  .chip{
    padding:8px 12px; border-radius:999px; border:1px solid var(--line);
    background:#0f1724; color:var(--text); cursor:pointer; user-select:none;
  }
  .chip.active{ background:var(--accent); color:var(--accent-ink); border-color:transparent; font-weight:700; }

  button{
    padding:12px 16px; border-radius:10px; border:1px solid transparent;
    background:var(--accent); color:var(--accent-ink); font-weight:800; cursor:pointer;
  }
  button[disabled]{ opacity:.6; cursor:not-allowed; }

  /* Score table */
  table.scoretable{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden;
    border:1px solid var(--line); border-radius:12px; background:#0e1420; }
  table.scoretable th, table.scoretable td{ padding:12px 10px; border-bottom:1px solid #172033; text-align:center; }
  table.scoretable thead th{ background:#101a2a; font-weight:800; }
  table.scoretable tr:last-child td{ border-bottom:none; }
  table.scoretable td:first-child, table.scoretable th:first-child{ text-align:left; width:260px; }

  .rank-badge{
    display:inline-flex; align-items:center; gap:6px;
    background:#0f1b2c; border:1px solid #1e2a42; border-radius:999px; padding:4px 10px; font-weight:700;
  }
  .rank-badge .dot{ width:8px; height:8px; border-radius:50%; background:var(--accent); display:inline-block; }

  .help{ font-size:.9rem; margin-top:8px; color:var(--muted); }
  .error{ color:var(--danger); margin-top:10px; }
  .success{ color:var(--success); margin-left:10px; }

  .row-inline{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .tight-num{ max-width:80px; }

  /* permanently visible TB inputs look disabled until needed */
  .disabled-like{ opacity:.5; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Round 1 Score Submission</h1>
    <p class="muted">Pick the winner, we’ll auto‑fill the opponent based on Round 1 pairings. Third set can be a full set or a 10‑point match tiebreak.</p>
  </header>

  <section class="card">
    <fieldset>
      <legend>Players</legend>
      <div class="grid">
        <label for="winner">Winner</label>
        <select id="winner" required>
          <option value="">Loading players…</option>
        </select>

        <label for="opponent">Opponent</label>
        <input id="opponent" type="text" readonly placeholder="Will auto‑fill after you pick a winner" />
      </div>
    </fieldset>
  </section>

  <section class="card">
    <fieldset>
      <legend>Scores</legend>

      <div class="row-inline" style="margin-bottom:8px;">
        <span class="muted">Match status:</span>
        <div class="chips" role="tablist" aria-label="Match status">
          <span id="chip-completed" class="chip active" data-status="Completed" role="button" tabindex="0">Completed</span>
          <span id="chip-retired"   class="chip" data-status="Retired"   role="button" tabindex="0">Retired</span>
          <span id="chip-walkover"  class="chip" data-status="Walkover"  role="button" tabindex="0">Walkover</span>
        </div>
      </div>

      <div class="row-inline" style="margin-bottom:12px;">
        <label class="row-inline" for="isTb" style="gap:10px;">
          <input id="isTb" type="checkbox" /> Use 10‑point <b>match</b> tiebreak instead of full third set
        </label>
        <span class="help">Tiebreak boxes are always visible but only accept input when a set score is 7–6.</span>
      </div>

      <table class="scoretable" aria-label="Set scores">
        <thead>
          <tr>
            <th></th>
            <th>Set 1</th>
            <th>Set 2</th>
            <th id="col3Header">Set 3</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="winnerLabel"><span class="rank-badge"><span class="dot"></span><span>Winner</span></span></td>
            <td><input id="s1w" class="tight-num" type="number" min="0" max="7" inputmode="numeric" aria-label="Winner Set 1" /></td>
            <td><input id="s2w" class="tight-num" type="number" min="0" max="7" inputmode="numeric" aria-label="Winner Set 2" /></td>
            <td id="s3wCell"><input id="s3w" class="tight-num" type="number" min="0" max="15" inputmode="numeric" aria-label="Winner Set 3 or Match TB" /></td>
          </tr>
          <tr>
            <td id="opponentLabel"><span class="rank-badge"><span class="dot"></span><span>Opponent</span></span></td>
            <td><input id="s1o" class="tight-num" type="number" min="0" max="7" inputmode="numeric" aria-label="Opponent Set 1" /></td>
            <td><input id="s2o" class="tight-num" type="number" min="0" max="7" inputmode="numeric" aria-label="Opponent Set 2" /></td>
            <td id="s3oCell"><input id="s3o" class="tight-num" type="number" min="0" max="15" inputmode="numeric" aria-label="Opponent Set 3 or Match TB" /></td>
          </tr>
          <tr>
            <td><b>Tie‑break</b> <span class="muted">(winner points)</span></td>
            <!-- PERMANENT TB inputs; disabled unless that set is 7–6 -->
            <td><input id="s1tb" class="tight-num disabled-like" type="number" min="0" inputmode="numeric" placeholder="S1 TB" aria-label="Set 1 tie-break (winner points)" disabled /></td>
            <td><input id="s2tb" class="tight-num disabled-like" type="number" min="0" inputmode="numeric" placeholder="S2 TB" aria-label="Set 2 tie-break (winner points)" disabled /></td>
            <td id="s3tbCell"><input id="s3tb" class="tight-num disabled-like" type="number" min="0" inputmode="numeric" placeholder="S3 TB" aria-label="Set 3 tie-break (winner points)" disabled /></td>
          </tr>
        </tbody>
      </table>

      <div id="msg" class="error" role="alert" aria-live="polite"></div>
    </fieldset>
  </section>

  <div class="row-inline">
    <button id="submitBtn" disabled>Submit score</button>
    <span id="ok" class="success" style="display:none;">Submitted. Thanks!</span>
  </div>
</div>

<script>
/*** ======= CONFIG ======= ***/
const PLAYERS_CSV_URL  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=0&single=true&output=csv';
const SCHEDULE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1596015267&single=true&output=csv';
const SUBMIT_ENDPOINT  = 'https://script.google.com/macros/s/AKfycbykGt3Xmkl9otVLUayoghMy7yv-jDL45hDWQCrGDklLlAVoXUlB2jTbQ4YlMKPeaOpNfg/exec';
/*** ======================= ***/

let players = [];
let nameByRank = new Map();
let rankByName = new Map();
let scheduleR1 = new Map();
let status = 'Completed';

function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const headers = lines[0].split(',').map(s=>s.trim());
  const rows = [];
  for (let i=1;i<lines.length;i++){
    const cols = lines[i].split(',').map(s=>s.trim());
    const obj={}; headers.forEach((h,idx)=>obj[h]=cols[idx]??''); rows.push(obj);
  }
  return {headers,rows};
}
function lastNameOf(full){ if(!full) return ''; const p=full.trim().split(/\s+/); return p[p.length-1].replace(/[.,]/g,''); }

async function loadPlayers(){
  const res = await fetch(PLAYERS_CSV_URL,{cache:'no-store'}); const text = await res.text();
  const {rows} = parseCSV(text); const norm=k=>k.toLowerCase();
  const mapped = rows.map(r=>{
    const m = new Map(Object.entries(r).map(([k,v])=>[norm(k),v]));
    return {
      name: m.get('participant')||m.get('name')||'',
      roundStart: Number(m.get('roundstart')||m.get('round start')||0),
      roundEnd: Number(m.get('roundend')||m.get('round end')||0),
      p: Number(m.get('round1points')||m.get('round 1 points')||0),
      pct: Number(m.get('round1percent')||m.get('round 1 percent')||0),
    };
  }).filter(p=>p.name);

  const eligible = mapped.filter(p=>p.roundStart<=1 && p.roundEnd>=1);
  eligible.sort((a,b)=>{
    if (b.p!==a.p) return b.p-a.p;
    if (b.pct!==a.pct) return b.pct-a.pct;
    const la=lastNameOf(a.name).toLowerCase(), lb=lastNameOf(b.name).toLowerCase();
    if (la<lb) return -1; if (la>lb) return 1; return a.name.localeCompare(b.name);
  });

  players = eligible; nameByRank.clear(); rankByName.clear();
  eligible.forEach((p,idx)=>{ const rank=idx+1; nameByRank.set(rank,p.name); rankByName.set(p.name,rank); });

  // NO RANKS IN DROPDOWN (names only)
  const sel=document.getElementById('winner');
  const names=[...eligible.map(p=>p.name)].sort((a,b)=>a.localeCompare(b));
  sel.innerHTML = '<option value="">Select winner…</option>' +
    names.map(n=>`<option value="${n}">${n}</option>`).join('');
}

async function loadScheduleR1(){
  const res = await fetch(SCHEDULE_CSV_URL,{cache:'no-store'}); const text = await res.text();
  const {headers,rows}=parseCSV(text);
  const idxRanking=headers.findIndex(h=>h.trim().toLowerCase()==='ranking');
  const idxR1=headers.findIndex(h=>['round 1','round1'].includes(h.trim().toLowerCase()));
  if (idxRanking===-1||idxR1===-1) throw new Error('Schedule CSV must have headers "Ranking" and "Round 1"');
  scheduleR1.clear();
  rows.forEach(r=>{
    const vals = Object.values(r);
    const rank=Number(vals[idxRanking]), opp=Number(vals[idxR1]);
    if(!Number.isNaN(rank)&&!Number.isNaN(opp)) scheduleR1.set(rank,opp);
  });
}

function setStatusChip(newStatus){
  status=newStatus;
  for (const id of ['chip-completed','chip-retired','chip-walkover']){
    const el=document.getElementById(id);
    if (el.dataset.status===newStatus) el.classList.add('active'); else el.classList.remove('active');
  }
  const disabled=(newStatus==='Walkover');
  ['s1w','s1o','s2w','s2o','s3w','s3o','s1tb','s2tb','s3tb','isTb']
    .forEach(id=>{ const el=document.getElementById(id); if(el) el.disabled=disabled; });
  document.getElementById('msg').textContent='';
}

function toggleTBUI(isTB){
  // Switch the third column between Set 3 and Match TB (re-use s3w/s3o)
  document.getElementById('col3Header').textContent = isTB ? 'Match TB' : 'Set 3';
  document.getElementById('s3wCell').classList.toggle('hidden', false);
  document.getElementById('s3oCell').classList.toggle('hidden', false);
  // hide the set-3 tiebreak input row when using match TB
  document.getElementById('s3tbCell').classList.toggle('hidden', isTB);
}

function labelWithRank(name, role){
  const rank = rankByName.get(name);
  const text = name ? `${name} (Rank ${rank ?? '—'})` : role;
  return `<span class="rank-badge"><span class="dot"></span><span>${text}</span></span>`;
}

function updateRowLabels(){
  const wName = document.getElementById('winner').value;
  const oName = document.getElementById('opponent').value;
  document.getElementById('winnerLabel').innerHTML   = labelWithRank(wName, 'Winner');
  document.getElementById('opponentLabel').innerHTML = labelWithRank(oName, 'Opponent');
}

function computeOpponent(){
  const winner=document.getElementById('winner').value;
  const out=document.getElementById('opponent'); out.value='';
  if(!winner){ updateRowLabels(); return; }
  const r=rankByName.get(winner);
  if(!r){ out.value='Rank not found'; updateRowLabels(); return; }
  const oppRank=scheduleR1.get(r);
  if(!oppRank){ out.value='No Round 1 opponent found'; updateRowLabels(); return; }
  const oppName=nameByRank.get(oppRank) || '(rank exists but player not in eligible list)';
  out.value=oppName||''; updateRowLabels();
}

/** TB enable/disable (permanent inputs, but only editable when 7–6) **/
function refreshTBEnabled(){
  const sets=[1,2,3];
  const isTB = document.getElementById('isTb').checked;
  sets.forEach(k=>{
    const w=document.getElementById(`s${k}w`);
    const o=document.getElementById(`s${k}o`);
    const tb=document.getElementById(`s${k}tb`);
    if (!w || !o || !tb) return;
    // If using match TB for third "set", there is no set-3 TB box
    if (k===3 && isTB){
      tb.value=''; tb.disabled=true; tb.classList.add('disabled-like'); return;
    }
    const a=Number(w.value), b=Number(o.value);
    const need=((a===7&&b===6)||(a===6&&b===7));
    tb.disabled = !need;
    tb.classList.toggle('disabled-like', !need);
    if(!need) tb.value='';
  });
}

function readInt(id){
  const el=document.getElementById(id);
  if(!el) return '';
  const v=el.value.trim();
  if (v==='') return '';
  const n=Number(v);
  return Number.isNaN(n) ? '' : n;  // return "" if blank/invalid, else number
}

function validateScores(){
  const msg=document.getElementById('msg'); msg.textContent='';
  if (status==='Walkover') return true;
  const isTB=document.getElementById('isTb').checked;

  const s1w=readInt('s1w'), s1o=readInt('s1o'), s1tb=readInt('s1tb');
  const s2w=readInt('s2w'), s2o=readInt('s2o'), s2tb=readInt('s2tb');
  const s3w=readInt('s3w'), s3o=readInt('s3o'), s3tb=readInt('s3tb');

  const haveS1 = s1w!=='' && s1o!=='';
  const haveS2 = s2w!=='' && s2o!=='';

  if (status==='Retired'){
    if(!(haveS1||haveS2||s3w!==''||s3o!=='')){
      msg.textContent='Please enter whatever score progress existed before retirement.'; return false;
    }
    return true;
  }

  if (!haveS1 || !haveS2){ msg.textContent='Enter Set 1 and Set 2 scores.'; return false; }

  // TB required when 7–6
  const needTB1=((s1w===7&&s1o===6)||(s1w===6&&s1o===7)); if(needTB1 && s1tb===''){ msg.textContent='Enter tie‑break points for Set 1.'; return false; }
  const needTB2=((s2w===7&&s2o===6)||(s2w===6&&s2o===7)); if(needTB2 && s2tb===''){ msg.textContent='Enter tie‑break points for Set 2.'; return false; }

  const winSet=(a,b)=>a!=='' && b!=='' && a>b;
  let won=0, lost=0;
  if (winSet(s1w,s1o)) won++; else lost++;
  if (winSet(s2w,s2o)) won++; else lost++;

  if (won===2) return true;

  if (won===1 && lost===1){
    if (isTB){
      // Use s3w/s3o as the match TB values
      if (s3w==='' || s3o===''){ msg.textContent='Enter the match tiebreak score in the Set 3 boxes.'; return false; }
      if (s3w < 10 || (s3w - s3o) < 2){ msg.textContent='Match tiebreak must be at least 10 and win by 2 for the winner.'; return false; }
      return true;
    } else {
      if (s3w==='' || s3o===''){ msg.textContent='Enter Set 3 score or choose match tiebreak.'; return false; }
      const needTB3=((s3w===7&&s3o===6)||(s3w===6&&s3o===7)); if(needTB3 && s3tb===''){ msg.textContent='Enter tie‑break points for Set 3.'; return false; }
      if (!(s3w > s3o)){ msg.textContent='Winner must win Set 3.'; return false; }
      return true;
    }
  }

  msg.textContent='Scores must reflect the selected winner.';
  return false;
}

async function submitForm(){
  const btn=document.getElementById('submitBtn');
  const ok=document.getElementById('ok');
  const msg=document.getElementById('msg');
  msg.textContent=''; ok.style.display='none';

  const winner=document.getElementById('winner').value;
  const opponent=document.getElementById('opponent').value;
  if (!winner){ msg.textContent='Pick a winner.'; return; }
  if (!opponent){ msg.textContent='Opponent not found yet.'; return; }
  if (!validateScores()) return;

  // compute TB-needed flags (useful on the sheet)
  const s1w=readInt('s1w'), s1o=readInt('s1o');
  const s2w=readInt('s2w'), s2o=readInt('s2o');
  const s3w=readInt('s3w'), s3o=readInt('s3o');
  const isTB=document.getElementById('isTb').checked;

  const needTB1 = (s1w===7 && s1o===6) || (s1w===6 && s1o===7);
  const needTB2 = (s2w===7 && s2o===6) || (s2w===6 && s2o===7);
  const needTB3 = !isTB && ((s3w===7 && s3o===6) || (s3w===6 && s3o===7));

  // row‑3 TB winner points (per set)
  const s1tb = readInt('s1tb');
  const s2tb = readInt('s2tb');
  const s3tb = readInt('s3tb');

  // Optional back‑compat for your previous columns:
  // If match TB is used, fill TB_W/TB_O; otherwise keep them blank.
  const TB_W = isTB ? s3w : '';
  const TB_O = isTB ? s3o : '';

  const payload={
    timestamp:new Date().toISOString(),
    round:1,
    status,
    winner,
    opponent,
    winnerRank: rankByName.get(winner) || '',
    opponentRank: scheduleR1.get(rankByName.get(winner)) || '',
    isTiebreakThird: isTB,

    // set scores
    s1w, s1o,
    s2w, s2o,
    s3w, s3o,

    // NEW per-set tiebreak fields (winner points). Blank when not 7–6.
    Set1_T: s1tb,
    Set2_T: s2tb,
    Set3_T: s3tb,

    // (Optional) old columns for compatibility; safe to remove if not needed
    TB_W, TB_O,

    // flags (handy if you use them)
    needTB1, needTB2, needTB3
  };

  btn.disabled=true;
  try{
    await fetch(SUBMIT_ENDPOINT,{
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body:JSON.stringify(payload),
      mode:'no-cors'
    });
    ok.style.display='inline';
    ['s1w','s1o','s2w','s2o','s3w','s3o','s1tb','s2tb','s3tb'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.value='';
    });
    refreshTBEnabled();
  }catch(e){
    msg.textContent='Could not submit: '+e.message;
  }finally{
    btn.disabled=false;
  }
}

/*** wiring ***/
document.getElementById('isTb').addEventListener('change', e=>{ toggleTBUI(e.target.checked); refreshTBEnabled(); });
['chip-completed','chip-retired','chip-walkover'].forEach(id=>{
  document.getElementById(id).addEventListener('click', e=>setStatusChip(e.target.dataset.status));
});
// On any set score change, recompute TB enabled state
['s1w','s1o','s2w','s2o','s3w','s3o'].forEach(id=>{
  const el=document.getElementById(id);
  el.addEventListener('input', refreshTBEnabled);
});

document.getElementById('winner').addEventListener('change', computeOpponent);
document.getElementById('winner').addEventListener('change', updateRowLabels);
document.getElementById('submitBtn').addEventListener('click', submitForm);

// init
(async function init(){
  try{
    await Promise.all([loadPlayers(), loadScheduleR1()]);
    computeOpponent();
    updateRowLabels();
    toggleTBUI(false);
    setStatusChip('Completed');
    refreshTBEnabled(); // TB boxes permanent but disabled by default
    document.getElementById('submitBtn').disabled=false;
  }catch(e){
    document.getElementById('msg').textContent='Setup error: '+e.message;
  }
})();
</script>
</body>
</html>
