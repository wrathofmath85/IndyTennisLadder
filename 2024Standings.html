<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Indy Tennis Ladder — Rankings</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --bg:#0b0e14; --panel:#11161f; --muted:#8ea0b4; --text:#e9eef5; --rule:#253043;
    --accent:#5dd0ff; --accent-ink:#052c3a; --ok:#3bd37f; --bad:#ff6b6b;
    --chip:#1a2332; --chipBorder:#2a364a;
    --chipBlue:#173049; --chipBlueBorder:#284564;
    --chipPurple:#251e42; --chipPurpleBorder:#3b2f6a;
    --shadow: 0 20px 60px rgba(0,0,0,.45);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }
  html,body{background:linear-gradient(180deg,#0b0e14, #0b0e14 180px, #0d121b 100%); color:var(--text); min-height:100%;}
  body{ margin:24px; display:flex; justify-content:center; }
  .wrap{ width:100%; max-width:1100px; }
  header{ background:linear-gradient(180deg,#0f1521,#0d131e); border:1px solid var(--rule); border-radius:14px; padding:18px 18px 14px; box-shadow: var(--shadow);}
  .title{ display:flex; align-items:baseline; gap:12px; flex-wrap:wrap;}
  .title h1{ font-size:22px; margin:0; letter-spacing:.2px;}
  .round-select{ appearance:none; font-size:12px; padding:6px 28px 6px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--chipBorder); color:var(--muted); cursor:pointer; }
  .meta{ margin-top:8px; color:var(--muted); font-size:14px; display:flex; gap:10px; flex-wrap:wrap;}
  .meta .dot::before{content:"•"; margin:0 8px; color:#3a4b66;}
  .panel{ margin-top:18px; background:var(--panel); border:1px solid var(--rule); border-radius:12px; overflow:hidden;}
  table{ width:100%; border-collapse:collapse; font-size:14px; }
  thead th{ text-align:left; font-weight:600; color:#b9c6d8; background:#0f1521; border-bottom:1px solid var(--rule); padding:12px; position:sticky; top:0; z-index:2; box-shadow:0 2px 0 0 var(--rule); }
  tbody td{ border-bottom:1px solid var(--rule); padding:12px; vertical-align:top;}
  tbody tr:hover{ background:#0e1420;}
  .rank{ width:76px; color:#cdd8e6; font-variant-numeric: tabular-nums; }
  .name{ font-weight:600;}
  .points{ font-variant-numeric: tabular-nums; }
  .result{ font-weight:600;}
  .won{ color:var(--ok); }
  .lost{ color:var(--bad); }
  .loading, .error{ margin:22px 0; padding:14px 16px; border-radius:10px; background:#0f1521; border:1px solid var(--rule); color:#8ea0b4;}
  .badge{ display:none; padding:2px 8px; border-radius:999px; border:1px solid var(--chipBorder); background:var(--chip); color:var(--muted); font-size:12px; margin-right:8px; white-space:nowrap; }
  .badge-scheduled{ background:var(--chipBlue); border-color:var(--chipBlueBorder); }
  .badge-challenge{ background:var(--chipPurple); border-color:var(--chipPurpleBorder); }

  /* --- CLICKABLE POINT PILLS --- */
  .winner-pts, .loser-pts{
    display:inline-flex; align-items:center; gap:6px;
    margin-left:10px; padding:2px 8px; border-radius:999px; font-size:12px;
    cursor:pointer; user-select:none;
    position:relative; z-index:3; pointer-events:auto;
  }
  .loser-pts{ background:#1a2230; border:1px solid #2a3548; color:#bcd0e5; }
  .winner-pts{ background:#12261b; border:1px solid #284c37; color:#c9edd7; }
  .loser-pts b,.winner-pts b{ font-variant-numeric:tabular-nums; color:#e9eef5; }

  .result, .badge{ position:relative; z-index:1; }
  .panel table *{ pointer-events:auto; }

  /* --- MODAL + BACKDROP: FORCE ABOVE EVERYTHING --- */
  .backdrop{
    position:fixed; inset:0; background:rgba(8,12,20,.55);
    opacity:0; pointer-events:none; transition:opacity .15s ease;
    z-index:10000; /* above table/buttons */
  }
  .backdrop.show{ opacity:1; pointer-events:auto; }

  .modal{
    position:fixed; left:50%; top:50%;
    transform:translate(-50%,-46%) scale(.98);
    background:#0f1521; border:1px solid var(--rule);
    border-radius:16px; box-shadow:var(--shadow);
    width:min(92vw,560px); opacity:0;
    transition:opacity .15s ease, transform .18s ease;
    z-index:10001; /* above backdrop and pills */
  }
  .modal.show{ opacity:1; transform:translate(-50%,-50%) scale(1); }
  .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--rule); background:#11192a; border-top-left-radius:16px; border-top-right-radius:16px; }
  .modal-title{ font-weight:700; font-size:18px; letter-spacing:.2px; }
  .modal-close{ appearance:none; border:1px solid #334258; background:#1a2436; color:#c9d6e6; border-radius:8px; width:28px; height:28px; font-size:16px; line-height:26px; text-align:center; cursor:pointer; }
  .modal-body{ padding:16px; color:#d2deee; }
  .modal-body p{ margin:0 0 8px 0; line-height:1.5; }
  .modal-body .tip{ margin-top:10px; font-size:13px; color:#93a6bf; border-top:1px dashed #2a3750; padding-top:10px; }
  .footer-note{ color:#6e7f98; font-size:12px; margin-top:10px; }

  @media (max-width:720px){
    thead{ display:none; } table,tbody,tr,td{ display:block; width:100%; }
    tbody tr{ padding:12px 12px 6px; } tbody td{ border:0; padding:4px 0; }
    .rank-current{ order:-4; font-weight:700; }
    .rank-begin{ order:-3; font-weight:700; }
    .name{ order:-2; font-size:16px; } .points{ order:-1; }
    .badge{ display:inline-block; } .loser-pts,.winner-pts{ margin-left:0; margin-top:6px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>Indy Tennis Ladder</h1>
      <select id="roundSelect" class="round-select" aria-label="Select round"></select>
    </div>
    <div class="meta" id="roundMeta"></div>
  </header>

  <div class="panel">
    <div class="loading" id="status">Loading data…</div>
    <table id="ladder" style="display:none;">
      <thead>
        <tr>
          <th class="rank">Current Ranking</th>
          <th class="rank">Beginning of Round Ranking</th>
          <th>Participant</th>
          <th class="points">Points</th>
          <th>Scheduled Opponent / Result</th>
          <th>Challenge Opponent / Result</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="footer-note">Tip: you can also use <code>?round=2</code> while testing.</div>
</div>

<div class="backdrop" id="backdrop" aria-hidden="true"></div>
<div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="modal-header">
    <div class="modal-title" id="modalTitle">Points</div>
    <button class="modal-close" id="modalClose" aria-label="Close">×</button>
  </div>
  <div class="modal-body" id="modalBody"></div>
</div>

<script>
/* ===== CONFIG ===== */
const CurrentRound = 2;

const CSV = {
  Players:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=0&single=true&output=csv',
  Schedule: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1596015267&single=true&output=csv',
  Dates:    'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=838168726&single=true&output=csv',
  ScoresRound1:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1813586077&single=true&output=csv',
  ScoresRound2:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=667416587&single=true&output=csv',
  ScoresRound3:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1340896382&single=true&output=csv',
  ScoresRound4:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1779797386&single=true&output=csv',
  ScoresRound5:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1138515130&single=true&output=csv',
  ScoresRound6:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=2117392535&single=true&output=csv',
  ScoresRound7:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=454354939&single=true&output=csv',
  ScoresRound8:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1429948565&single=true&output=csv',
  ScoresRound9:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=656808017&single=true&output=csv',
  ScoresRound10: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1886048839&single=true&output=csv'
};

let ROUND = (() => {
  const u = new URLSearchParams(location.search);
  const q = parseInt(u.get('round'), 10);
  if (!isNaN(q) && q >= 1 && q <= CurrentRound) return q;
  return CurrentRound;
})();

/* ===== Helpers ===== */
function loadCSV(url){
  return new Promise((resolve, reject) => {
    if (!url) return resolve([]);
    Papa.parse(url, { download: true, header: true, skipEmptyLines: 'greedy',
      complete: (res) => resolve(res.data || []),
      error: (err) => reject(err)
    });
  });
}
const nameKey = s => String(s||'').trim().toLowerCase();
const lastName = s => { const parts = String(s||'').trim().split(/\s+/); return parts.length ? parts[parts.length-1] : ''; };
const num = v => (v===null || v===undefined || v==='') ? NaN : +String(v).toString().replace(/[% ,]/g,'');
const safeNum = v => { const n = num(v); return isNaN(n)?0:n; };
const fmt = (v) => v===undefined || v===null ? '' : String(v);

function fmtDateRange(startRaw, endRaw){
  const tryParse = (val) => {
    if (val === undefined || val === null || val === '') return null;
    if (/^\d+(\.\d+)?$/.test(String(val))) {
      const days = Number(val);
      const base = new Date(Date.UTC(1899,11,30));
      return new Date(base.getTime() + days*86400000);
    }
    const d = new Date(val);
    return isNaN(d) ? null : d;
  };
  const s = tryParse(startRaw), e = tryParse(endRaw);
  const nice = (d) => d.toLocaleDateString(undefined, {month:'short', day:'numeric'});
  if (s && e) return `${nice(s)} – ${nice(e)}`;
  if (s) return nice(s);
  if (e) return nice(e);
  return [fmt(startRaw), fmt(endRaw)].filter(Boolean).join(' – ');
}
function setStatus(msg, isError=false){
  const st = document.getElementById('status');
  st.textContent = msg;
  st.className = isError ? 'error' : 'loading';
}

/* Modal helpers */
const backdropEl = document.getElementById('backdrop');
const modalEl = document.getElementById('modal');
const modalBody = document.getElementById('modalBody');
const modalTitle = document.getElementById('modalTitle');
document.getElementById('modalClose').addEventListener('click', closeModal);
backdropEl.addEventListener('click', closeModal);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
function openModal(title, html){
  modalTitle.textContent = title || 'Info';
  modalBody.innerHTML = html;
  backdropEl.classList.add('show'); modalEl.classList.add('show');
  backdropEl.setAttribute('aria-hidden','false'); modalEl.setAttribute('aria-hidden','false');
  // lock scroll while modal is open
  document.documentElement.style.overflow = 'hidden';
  document.body.style.overflow = 'hidden';
}
function closeModal(){
  modalEl.classList.remove('show'); backdropEl.classList.remove('show');
  backdropEl.setAttribute('aria-hidden','true'); modalEl.setAttribute('aria-hidden','true');
  // restore scroll
  document.documentElement.style.overflow = '';
  document.body.style.overflow = '';
}

/* Tennis helpers */
function hasThirdSetTB(row){ return fmt(row.TB_W) !== '' || fmt(row.TB_O) !== ''; }
function parseGameTotals(row){
  if ('GamesWon' in row && 'GamesLost' in row){
    const w = safeNum(row.GamesWon), o = safeNum(row.GamesLost);
    return { wGames:w, oGames:o, diff: Math.max(0, w - o) };
  }
  const W1=safeNum(row.S1_W), O1=safeNum(row.S1_O);
  const W2=safeNum(row.S2_W), O2=safeNum(row.S2_O);
  const W3=safeNum(row.S3_W), O3=safeNum(row.S3_O);
  const TBW=safeNum(row.TB_W), TBO=safeNum(row.TB_O);
  let wGames = W1 + W2, oGames = O1 + O2;
  if (hasThirdSetTB(row)){ if (TBW > TBO){ wGames += 1; } else if (TBO > TBW){ oGames += 1; } }
  else if (W3 !== 0 || O3 !== 0){ wGames += W3; oGames += O3; }
  return { wGames, oGames, diff: Math.max(0, wGames - oGames) };
}
function formatThirdEntry(row, perspective){
  if (!hasThirdSetTB(row)){
    const W3 = fmt(row.S3_W), O3 = fmt(row.S3_O);
    if (W3 === '' && O3 === '') return '';
    return perspective === 'winner' ? ` ${W3}-${O3}` : ` ${O3}-${W3}`;
  }
  const a = fmt(row.TB_W), b = fmt(row.TB_O);
  if (a === '' && b === '') return '';
  return perspective === 'winner' ? ` ${a}-${b}` : ` ${b}-${a}`;
}

/* ===== Core ===== */
async function init(round){
  ROUND = round;

  // update UI + URL
  const sel = document.getElementById('roundSelect');
  if (sel.value !== String(ROUND)) sel.value = String(ROUND);
  const url = new URL(location.href);
  url.searchParams.set('round', String(ROUND));
  history.replaceState(null, '', url);

  try{
    setStatus('Loading data…');
    document.getElementById('ladder').style.display = 'none';

    const roundKey = `ScoresRound${ROUND}`;
    const [playersRaw, scoresRawAll, scheduleRaw, datesRaw] = await Promise.all([
      loadCSV(CSV.Players),
      loadCSV(CSV[roundKey]),
      loadCSV(CSV.Schedule),
      loadCSV(CSV.Dates)
    ]);

    // dates header
    const roundRow = datesRaw.find(r => Number(r.Round) === Number(ROUND));
    if (roundRow){
      const span = fmtDateRange(roundRow.Start, roundRow.End);
      const type = fmt(roundRow.Type);
      const meta = document.getElementById('roundMeta');
      meta.textContent = '';
      const a = document.createElement('span'); a.textContent = span || ''; meta.appendChild(a);
      if (type){ const dot = document.createElement('span'); dot.className = 'dot'; dot.textContent = type; meta.appendChild(dot); }
    }

    // Active this round
    const activePlayersRaw = playersRaw.filter(r => {
      const start = num(r.RStart), end = num(r.REnd), rr = Number(ROUND);
      return (isNaN(start) || start <= rr) && (isNaN(end) || end >= rr);
    });

    // ---- Current Ranking (always R8Pts/R8Perc) ----
    const currentPlayers = activePlayersRaw.map(r => ({
      Participant: fmt(r.Participant),
      CurrPts: num(r.R8Pts),
      CurrPerc: num(r.R8Perc),
    })).sort((a,b)=>{
      const pA = isNaN(a.CurrPts)?-Infinity:a.CurrPts, pB = isNaN(b.CurrPts)?-Infinity:b.CurrPts;
      if (pA !== pB) return pB - pA;
      const qA = isNaN(a.CurrPerc)?-Infinity:a.CurrPerc, qB = isNaN(b.CurrPerc)?-Infinity:b.CurrPerc;
      if (qA !== qB) return qB - qA;
      return a.Participant.localeCompare(b.Participant, undefined, {sensitivity:'base'});
    });
    const currentRankByName = {};
    currentPlayers.forEach((p,i)=> currentRankByName[nameKey(p.Participant)] = i+1);

    // ---- Beginning-of-Round Ranking (R#Pts/R#Perc) ----
    const ptsLabel  = `R${ROUND}Pts`;
    const percLabel = `R${ROUND}Perc`;
    const beginPlayers = activePlayersRaw.map(r => ({
      Participant: fmt(r.Participant),
      BeginPts: num(r[ptsLabel]),
      BeginPerc: num(r[percLabel]),
    })).sort((a,b)=>{
      const pA = isNaN(a.BeginPts)?-Infinity:a.BeginPts, pB = isNaN(b.BeginPts)?-Infinity:b.BeginPts;
      if (pA !== pB) return pB - pA;
      const qA = isNaN(a.BeginPerc)?-Infinity:a.BeginPerc, qB = isNaN(b.BeginPerc)?-Infinity:b.BeginPerc;
      if (qA !== qB) return qB - qA;
      return a.Participant.localeCompare(b.Participant, undefined, {sensitivity:'base'});
    });

    const beginRankByName = {}, nameByBeginRank = {};
    beginPlayers.forEach((p,i)=>{ p.BeginRank=i+1; beginRankByName[nameKey(p.Participant)]=p.BeginRank; nameByBeginRank[p.BeginRank]=p.Participant; });

    // Schedule map uses beginning-of-round ranks
    const scheduleCol = `Round ${ROUND}`;
    const scheduleMap = {};
    (scheduleRaw||[]).forEach(r=>{
      const rnk = Number(r.Ranking), opp = Number(r[scheduleCol]);
      if (!isNaN(rnk) && !isNaN(opp)) scheduleMap[rnk] = opp;
    });

    // Round CSV (filter if it still carries a "Round" column)
    const scoresRaw = (scoresRawAll||[]).filter(r => {
      const rr = Number(r.Round);
      return isNaN(rr) || rr === Number(ROUND);
    });

    // Build result indices; notes use beginning-of-round ranks
    const scheduled = new Map();
    const challenge = new Map();

    function resultString(row, perspective){
      const winner = fmt(row.Winner), opponent = fmt(row.Opponent);
      const wRank = beginRankByName[nameKey(winner)] || '?';
      const oRank = beginRankByName[nameKey(opponent)] || '?';
      const W1 = fmt(row.S1_W), O1 = fmt(row.S1_O);
      const W2 = fmt(row.S2_W), O2 = fmt(row.S2_O);
      const set1 = `${W1}-${O1}`, set2 = `${W2}-${O2}`;
      const set3 = formatThirdEntry(row, perspective);
      return (perspective === 'winner')
        ? `Beat #${oRank} ${opponent} ${set1} ${set2}${set3}`
        : `Lost to #${wRank} ${winner} ${O1}-${W1} ${O2}-${W2}${formatThirdEntry(row, 'opponent')}`;
    }

    scoresRaw.forEach(r=>{
      const type = String(r.MatchType||'').trim();
      if (type !== 'Scheduled' && type !== 'Challenge') return;

      const winner = fmt(r.Winner), opponent = fmt(r.Opponent);
      const wKey = nameKey(winner), oKey = nameKey(opponent);
      const wRank = beginRankByName[wKey], oRank = beginRankByName[oKey];

      const { wGames, oGames, diff } = parseGameTotals(r);
      const upset = String(r.Upset||'').toUpperCase() === 'YES' ? 'YES' : 'NO';

      const target = (type === 'Scheduled') ? scheduled : challenge;

      target.set(wKey, { text: resultString(r,'winner'), isLoss:false, row:r,
                         wRank, oRank, upset, type, gw:wGames, gl:oGames, gdiff:diff });

      target.set(oKey, { text: resultString(r,'opponent'), isLoss:true, row:r,
                         wRank:oRank, oRank:wRank, upset:'NO', type, gw:oGames, gl:wGames,
                         gdiff:Math.max(0,oGames - wGames) });
    });

    // ------- Render by CURRENT ranking -------
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';
    currentPlayers.forEach((cp, idx)=>{
      const tr = document.createElement('tr');

      const meKey = nameKey(cp.Participant);
      const currentRank = idx + 1; // already sorted by current
      const beginRank = beginRankByName[meKey] || '';

      const tdCurr = document.createElement('td'); tdCurr.className='rank rank-current'; tdCurr.textContent = `#${currentRank}`; tr.appendChild(tdCurr);
      const tdBegin = document.createElement('td'); tdBegin.className='rank rank-begin'; tdBegin.textContent = beginRank ? `#${beginRank}` : ''; tr.appendChild(tdBegin);
      const tdName = document.createElement('td'); tdName.className='name'; tdName.textContent = cp.Participant; tr.appendChild(tdName);

      const tdPts  = document.createElement('td'); tdPts.className='points';
      tdPts.textContent = !isNaN(cp.CurrPts) ? cp.CurrPts : '';
      tr.appendChild(tdPts);

      const tdSched = document.createElement('td');
      const sr = scheduled.get(meKey);
      if (sr){
        const pill = document.createElement('span'); pill.className='badge badge-scheduled'; pill.textContent='Scheduled'; tdSched.appendChild(pill);
        const span = document.createElement('span'); span.className='result ' + (sr.isLoss ? 'lost' : 'won'); span.textContent=sr.text; tdSched.appendChild(span);

        if (sr.isLoss){
          const baseGames = sr.gw;
          const base = 'LosePoints' in sr.row ? safeNum(sr.row.LosePoints) : Math.min(10, baseGames);
          const final = base;

          const btn = document.createElement('button');
          btn.type='button'; btn.className='loser-pts';
          btn.setAttribute('data-role','loser');
          btn.setAttribute('data-points', String(final));
          btn.setAttribute('data-gameswon', String(baseGames));
          btn.setAttribute('data-chaldiv','');
          btn.innerHTML = `<b>${final}</b> pts`;
          tdSched.appendChild(btn);
        }else{
          const base = ('WinPoints' in sr.row) ? safeNum(sr.row.WinPoints)
                                               : (sr.upset==='YES'
                                                  ? Math.max(15, Math.min(25, Math.round(10 + sr.gdiff * ((sr.wRank - sr.oRank)/2))))
                                                  : Math.max(11, Math.round(10 + sr.gdiff)));
          const final = base;

          const btn = document.createElement('button');
          btn.type='button'; btn.className='winner-pts';
          btn.setAttribute('data-role','winner');
          btn.setAttribute('data-points', String(final));
          btn.setAttribute('data-upset', sr.upset);
          btn.setAttribute('data-gw', String(sr.gw));
          btn.setAttribute('data-gl', String(sr.gl));
          btn.setAttribute('data-gdiff', String(sr.gdiff));
          btn.setAttribute('data-wrank', String(sr.wRank||''));
          btn.setAttribute('data-orank', String(sr.oRank||''));
          btn.setAttribute('data-chaldiv','');
          btn.innerHTML = `<b>${final}</b> pts`;
          tdSched.appendChild(btn);
        }
      }else{
        const oppRank = beginRank ? scheduleMap[beginRank] : undefined;
        if (oppRank){
          const oppName = nameByBeginRank[oppRank] || '';
          const span = document.createElement('span');
          span.innerHTML = `<span class="badge badge-scheduled">Scheduled</span> #${oppRank} ${oppName || ''}`;
          tdSched.appendChild(span);
        }
      }
      tr.appendChild(tdSched);

      const tdChal = document.createElement('td');
      const cr = challenge.get(meKey);
      if (cr){
        const pill = document.createElement('span'); pill.className='badge badge-challenge'; pill.textContent='Challenge'; tdChal.appendChild(pill);
        const span = document.createElement('span'); span.className='result ' + (cr.isLoss ? 'lost' : 'won'); span.textContent=cr.text; tdChal.appendChild(span);

        const hasScheduled = scheduled.has(meKey);
        const divisor = hasScheduled ? 2 : 4;

        if (cr.isLoss){
          const baseGames = cr.gw;
          const base = 'LosePoints' in cr.row ? safeNum(cr.row.LosePoints) : Math.min(10, baseGames);
          const final = Math.round(base / divisor);

          const btn = document.createElement('button');
          btn.type='button'; btn.className='loser-pts';
          btn.setAttribute('data-role','loser');
          btn.setAttribute('data-points', String(final));
          btn.setAttribute('data-gameswon', String(baseGames));
          btn.setAttribute('data-chaldiv', String(divisor));
          btn.innerHTML = `<b>${final}</b> pts`;
          tdChal.appendChild(btn);
        }else{
          const base = ('WinPoints' in cr.row) ? safeNum(cr.row.WinPoints)
                                               : (cr.upset==='YES'
                                                  ? Math.max(15, Math.min(25, Math.round(10 + cr.gdiff * ((cr.wRank - cr.oRank)/2))))
                                                  : Math.max(11, Math.round(10 + cr.gdiff)));
          const final = Math.round(base / divisor);

          const btn = document.createElement('button');
          btn.type='button'; btn.className='winner-pts';
          btn.setAttribute('data-role','winner');
          btn.setAttribute('data-points', String(final));
          btn.setAttribute('data-upset', cr.upset);
          btn.setAttribute('data-gw', String(cr.gw));
          btn.setAttribute('data-gl', String(cr.gl));
          btn.setAttribute('data-gdiff', String(cr.gdiff));
          btn.setAttribute('data-wrank', String(cr.wRank||''));
          btn.setAttribute('data-orank', String(cr.oRank||''));
          btn.setAttribute('data-chaldiv', String(divisor));
          btn.innerHTML = `<b>${final}</b> pts`;
          tdChal.appendChild(btn);
        }
      }
      tr.appendChild(tdChal);

      tbody.appendChild(tr);
    });

    document.getElementById('ladder').style.display = '';
    setStatus(''); document.getElementById('status').style.display = 'none';
  }catch(err){
    console.error(err);
    setStatus('There was a problem loading your data. Double-check the CSV links and headers.', true);
  }
}

/* Round select */
function buildRoundSelect(){
  const sel = document.getElementById('roundSelect');
  sel.innerHTML = '';
  for (let r=1; r<=CurrentRound; r++){
    const opt = document.createElement('option');
    opt.value = String(r);
    opt.textContent = `Round ${r}`;
    sel.appendChild(opt);
  }
  sel.value = String(ROUND);
  sel.addEventListener('change', () => {
    const r = parseInt(sel.value,10);
    if (!isNaN(r) && r>=1 && r<=CurrentRound) init(r);
  });
}

/* ===== Unified handler bound to both click & pointerup ===== */
function handlePointsClick(e){
  const loserBtn  = e.target.closest('.loser-pts');
  const winnerBtn = e.target.closest('.winner-pts');
  if (!loserBtn && !winnerBtn) return;

  e.preventDefault();
  e.stopPropagation();

  if (loserBtn){
    const pts  = loserBtn.getAttribute('data-points') || '';
    const gw   = loserBtn.getAttribute('data-gameswon') || '0';
    const div  = loserBtn.getAttribute('data-chaldiv') || '';
    const isChallenge = div && div !== '' && div !== '1';

    const html = `
      <p><strong>Total number of games won:</strong> ${gw}</p>
      <p><strong>Points awarded:</strong> ${pts}</p>
      ${isChallenge ? `
        <p><strong>Challenge divider:</strong> ${div}</p>
        <p class="tip">Divided by 2 when scheduled match is played; divided by 4 when scheduled match is not played.</p>
      ` : ``}
      <p class="tip">Losers receive the number of games won, but no more than 10.</p>
    `;
    openModal('Loser Points', html);
    return;
  }

  if (winnerBtn){
    const pts   = winnerBtn.getAttribute('data-points') || '';
    const upset = (winnerBtn.getAttribute('data-upset') || 'NO').toUpperCase();
    const gw    = winnerBtn.getAttribute('data-gw') || '0';
    const gl    = winnerBtn.getAttribute('data-gl') || '0';
    const gd    = winnerBtn.getAttribute('data-gdiff') || '0';
    const wr    = winnerBtn.getAttribute('data-wrank') || '';
    const orr   = winnerBtn.getAttribute('data-orank') || '';
    const rdiff = (wr && orr) ? Math.abs(Number(wr)-Number(orr)) : '';
    const div   = winnerBtn.getAttribute('data-chaldiv') || '';
    const isChallenge = div && div !== '' && div !== '1';
    const topAlert = (upset === 'YES') ? `<p><strong>UPSET ALERT!</strong></p>` : ``;

    const body = (upset === 'YES')
      ? `
          <p><strong>Games won:</strong> ${gw}, <strong>Games lost:</strong> ${gl}, <strong>Difference in games:</strong> ${gd}</p>
          <p><strong>Rank:</strong> ${wr}, <strong>Opponent Rank:</strong> ${orr}, <strong>Difference in rank:</strong> ${rdiff}</p>
          <p><strong>Points awarded:</strong> ${pts}</p>
          ${isChallenge ? `
            <p><strong>Challenge divider:</strong> ${div}</p>
            <p class="tip">Divided by 2 when scheduled match is played; divided by 4 when scheduled match is not played.</p>
          ` : ``}
          <p class="tip">Upset winners receive 10 + (difference in games won/lost × difference in ranking / 2), minimum 15, maximum 25.</p>
        `
      : `
          <p><strong>Games won:</strong> ${gw}, <strong>Games lost:</strong> ${gl}, <strong>Difference:</strong> ${gd}</p>
          <p><strong>Points awarded:</strong> ${pts}</p>
          ${isChallenge ? `
            <p><strong>Challenge divider:</strong> ${div}</p>
            <p class="tip">Divided by 2 when scheduled match is played; divided by 4 when scheduled match is not played.</p>
          ` : ``}
          <p class="tip">Winners receive 10 + (difference in games won/lost), minimum 11.</p>
        `;
    openModal('Winner Points', `${topAlert}${body}`);
  }
}

document.addEventListener('click', handlePointsClick, { capture:false });
document.addEventListener('pointerup', handlePointsClick, { capture:false });

/* Boot */
buildRoundSelect();
init(ROUND);
</script>
</body>
</html>
