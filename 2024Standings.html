<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Indy Tennis Ladder — Rankings</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --bg:#0b0e14; --panel:#11161f; --muted:#8ea0b4; --text:#e9eef5; --rule:#253043;
    --accent:#5dd0ff; --accent-ink:#052c3a; --ok:#3bd37f; --bad:#ff6b6b;
    --chip:#1a2332; --chipBorder:#2a364a;
    --chipBlue:#173049; --chipBlueBorder:#284564;
    --chipPurple:#251e42; --chipPurpleBorder:#3b2f6a;
    --shadow: 0 20px 60px rgba(0,0,0,.45);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }
  html,body{background:linear-gradient(180deg,#0b0e14, #0b0e14 180px, #0d121b 100%); color:var(--text); min-height:100%;}
  body{ margin:24px; display:flex; justify-content:center; }
  .wrap{ width:100%; max-width:1100px; }
  header{ background:linear-gradient(180deg,#0f1521,#0d131e); border:1px solid var(--rule); border-radius:14px; padding:18px 18px 14px; box-shadow: 0 6px 30px rgba(0,0,0,.35);}
  .title{ display:flex; align-items:baseline; gap:12px; flex-wrap:wrap;}
  .title h1{ font-size:22px; margin:0; letter-spacing:.2px;}

  /* Round pill -> dropdown */
  .round-select{
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    font-size:12px; padding:6px 28px 6px 10px; border-radius:999px;
    background:var(--chip); border:1px solid var(--chipBorder); color:var(--muted);
    cursor:pointer; position:relative; line-height:1.1;
  }
  .round-select:focus{ outline:2px solid #2c4564; outline-offset:2px; }

  .meta{ margin-top:8px; color:var(--muted); font-size:14px; display:flex; gap:10px; flex-wrap:wrap;}
  .meta .dot::before{content:"•"; margin:0 8px; color:#3a4b66;}
  .panel{ margin-top:18px; background:var(--panel); border:1px solid var(--rule); border-radius:12px; overflow:hidden;}
  table{ width:100%; border-collapse:collapse; font-size:14px; }
  thead th{
    text-align:left; font-weight:600; color:#b9c6d8; background:#0f1521;
    border-bottom:1px solid var(--rule); padding:12px;
    position: sticky; top: 0; z-index: 2;
    box-shadow: 0 2px 0 0 var(--rule);
  }
  tbody td{ border-bottom:1px solid var(--rule); padding:12px; vertical-align:top;}
  tbody tr:hover{ background:#0e1420;}
  .rank{ width:56px; color:#cdd8e6; }
  .name{ font-weight:600;}
  .points{ font-variant-numeric: tabular-nums; }
  .result{ font-weight:600;}
  .won{ color:var(--ok); }
  .lost{ color:var(--bad); }
  .loading, .error{ margin:22px 0; padding:14px 16px; border-radius:10px; background:#0f1521; border:1px solid var(--rule); color:var(--muted);}

  .badge{ display:none; padding:2px 8px; border-radius:999px; border:1px solid var(--chipBorder);
          background:var(--chip); color:var(--muted); font-size:12px; margin-right:8px; white-space:nowrap; }
  .badge-scheduled{ background:var(--chipBlue); border-color:var(--chipBlueBorder); }
  .badge-challenge{ background:var(--chipPurple); border-color:var(--chipPurpleBorder); }

  .loser-pts, .winner-pts{
    display:inline-flex; align-items:center; gap:6px;
    margin-left:10px; padding:2px 8px; border-radius:999px;
    font-size:12px; cursor:pointer; user-select:none;
  }
  .loser-pts{ background:#1a2230; border:1px solid #2a3548; color:#bcd0e5; }
  .winner-pts{ background:#12261b; border:1px solid #284c37; color:#c9edd7; }
  .loser-pts b, .winner-pts b{ font-variant-numeric:tabular-nums; color:#e9eef5; }

  .backdrop{
    position:fixed; inset:0; background:rgba(8,12,20,.55);
    opacity:0; pointer-events:none; transition:opacity .15s ease;
  }
  .backdrop.show{ opacity:1; pointer-events:auto; }
  .modal{
    position:fixed; left:50%; top:50%;
    transform:translate(-50%,-46%) scale(.98);
    background:#0f1521; border:1px solid var(--rule);
    border-radius:16px; box-shadow:var(--shadow);
    width:min(92vw,560px);
    opacity:0; transition:opacity .15s ease, transform .18s ease;
  }
  .modal.show{ opacity:1; transform:translate(-50%,-50%) scale(1); }
  .modal-header{
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px; border-bottom:1px solid var(--rule);
    background:#11192a; border-top-left-radius:16px; border-top-right-radius:16px;
  }
  .modal-title{ font-weight:700; font-size:18px; letter-spacing:.2px; }
  .modal-close{
    appearance:none; border:1px solid #334258; background:#1a2436; color:#c9d6e6;
    border-radius:8px; width:28px; height:28px; font-size:16px; line-height:26px;
    text-align:center; cursor:pointer;
  }
  .modal-body{ padding:16px; color:#d2deee; }
  .modal-body p{ margin:0 0 8px 0; line-height:1.5; }
  .modal-body .tip{
    margin-top:10px; font-size:13px; color:#93a6bf;
    border-top:1px dashed #2a3750; padding-top:10px;
  }

  .footer-note{ color:#6e7f98; font-size:12px; margin-top:10px; }

  @media (max-width:720px){
    thead{ display:none; }
    table, tbody, tr, td{ display:block; width:100%; }
    tbody tr{ padding:12px 12px 6px; }
    tbody td{ border:0; padding:4px 0; }
    .rank{ order:-3; font-weight:700; }
    .name{ order:-2; font-size:16px; }
    .points{ order:-1; }
    .badge{ display:inline-block; }
    .loser-pts,.winner-pts{ margin-left:0; margin-top:6px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>Indy Tennis Ladder</h1>
      <!-- Round dropdown (styled like a pill) -->
      <select id="roundSelect" class="round-select" aria-label="Select round"></select>
    </div>
    <div class="meta" id="roundMeta"></div>
  </header>

  <div class="panel">
    <div class="loading" id="status">Loading data…</div>
    <table id="ladder" style="display:none;">
      <thead>
        <tr>
          <th class="rank">#</th>
          <th>Participant</th>
          <th class="points">Points</th>
          <th>Scheduled Opponent / Result</th>
          <th>Challenge Opponent / Result</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="footer-note">Tip: you can also use <code>?round=2</code> while testing.</div>
</div>

<!-- Modal -->
<div class="backdrop" id="backdrop" aria-hidden="true"></div>
<div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="modal-header">
    <div class="modal-title" id="modalTitle">Points</div>
    <button class="modal-close" id="modalClose" aria-label="Close">×</button>
  </div>
  <div class="modal-body" id="modalBody"></div>
</div>

<script>
/* ============== CONFIG ============== */
const CurrentRound = 2; // update as the ladder progresses

const CSV = {
  Players:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=0&single=true&output=csv',
  Schedule: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1596015267&single=true&output=csv',
  Dates:    'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=838168726&single=true&output=csv',

  // 10 per-round Scores CSVs
  ScoresRound1:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1813586077&single=true&output=csv',
  ScoresRound2:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=667416587&single=true&output=csv',
  ScoresRound3:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1340896382&single=true&output=csv',
  ScoresRound4:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1779797386&single=true&output=csv',
  ScoresRound5:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1138515130&single=true&output=csv',
  ScoresRound6:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=2117392535&single=true&output=csv',
  ScoresRound7:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=454354939&single=true&output=csv',
  ScoresRound8:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1429948565&single=true&output=csv',
  ScoresRound9:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=656808017&single=true&output=csv',
  ScoresRound10: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1886048839&single=true&output=csv'
};

// Resolve initial round: ?round overrides but cannot exceed CurrentRound
let ROUND = (() => {
  const u = new URLSearchParams(location.search);
  const q = parseInt(u.get('round'), 10);
  if (!isNaN(q) && q >= 1 && q <= CurrentRound) return q;
  return CurrentRound;
})();

/* ============== HELPERS ============== */
function loadCSV(url){
  return new Promise((resolve, reject) => {
    if (!url) return resolve([]);
    Papa.parse(url, { download: true, header: true, skipEmptyLines: 'greedy',
      complete: (res) => resolve(res.data || []),
      error: (err) => reject(err)
    });
  });
}
const nameKey = s => String(s||'').trim().toLowerCase();
const lastName = s => { const parts = String(s||'').trim().split(/\s+/); return parts.length ? parts[parts.length-1] : ''; };
const num = v => (v===null || v===undefined || v==='') ? NaN : +String(v).toString().replace(/[% ,]/g,'');
const safeNum = v => { const n = num(v); return isNaN(n)?0:n; };
const fmt = (v) => v===undefined || v===null ? '' : String(v);

function fmtDateRange(startRaw, endRaw){
  const tryParse = (val) => {
    if (val === undefined || val === null || val === '') return null;
    if (/^\d+(\.\d+)?$/.test(String(val))) {
      const days = Number(val);
      const base = new Date(Date.UTC(1899,11,30));
      return new Date(base.getTime() + days*86400000);
    }
    const d = new Date(val);
    return isNaN(d) ? null : d;
  };
  const s = tryParse(startRaw), e = tryParse(endRaw);
  const nice = (d) => d.toLocaleDateString(undefined, {month:'short', day:'numeric'});
  if (s && e) return `${nice(s)} – ${nice(e)}`;
  if (s) return nice(s);
  if (e) return nice(e);
  return [fmt(startRaw), fmt(endRaw)].filter(Boolean).join(' – ');
}
function setStatus(msg, isError=false){
  const st = document.getElementById('status');
  st.textContent = msg;
  st.className = isError ? 'error' : 'loading';
}

/* Modal helpers */
const backdropEl = document.getElementById('backdrop');
const modalEl = document.getElementById('modal');
const modalBody = document.getElementById('modalBody');
const modalTitle = document.getElementById('modalTitle');
document.getElementById('modalClose').addEventListener('click', closeModal);
backdropEl.addEventListener('click', closeModal);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
function openModal(title, html){
  modalTitle.textContent = title || 'Info';
  modalBody.innerHTML = html;
  backdropEl.classList.add('show'); modalEl.classList.add('show');
  backdropEl.setAttribute('aria-hidden','false'); modalEl.setAttribute('aria-hidden','false');
}
function closeModal(){
  modalEl.classList.remove('show'); backdropEl.classList.remove('show');
  backdropEl.setAttribute('aria-hidden','true'); modalEl.setAttribute('aria-hidden','true');
}

/* ====== TENNIS-SPECIFIC HELPERS ====== */
function hasThirdSetTB(row){ return fmt(row.TB_W) !== '' || fmt(row.TB_O) !== ''; }
function formatThirdEntry(row, perspective){
  if (hasThirdSetTB(row)){
    const a = fmt(row.TB_W), b = fmt(row.TB_O);
    if (a === '' && b === '') return '';
    return perspective === 'winner' ? ` ${a}-${b}` : ` ${b}-${a}`;
  }else{
    const W3 = fmt(row.S3_W), O3 = fmt(row.S3_O);
    if (W3 === '' && O3 === '') return '';
    return perspective === 'winner' ? ` ${W3}-${O3}` : ` ${O3}-${W3}`;
  }
}

/* ============== CORE ============== */
async function init(round){
  ROUND = round;

  // update select UI and URL (keeps default limited to CurrentRound)
  const sel = document.getElementById('roundSelect');
  if (sel.value !== String(ROUND)) sel.value = String(ROUND);
  const url = new URL(location.href);
  url.searchParams.set('round', String(ROUND));
  history.replaceState(null, '', url);

  try{
    setStatus('Loading data…');
    document.getElementById('ladder').style.display = 'none';

    const roundKey = `ScoresRound${ROUND}`;
    const [playersRaw, scoresRawAll, scheduleRaw, datesRaw] = await Promise.all([
      loadCSV(CSV.Players),
      loadCSV(CSV[roundKey]),
      loadCSV(CSV.Schedule),
      loadCSV(CSV.Dates)
    ]);

    // Dates header
    const roundRow = datesRaw.find(r => Number(r.Round) === Number(ROUND));
    if (roundRow){
      const span = fmtDateRange(roundRow.Start, roundRow.End);
      const type = fmt(roundRow.Type);
      const meta = document.getElementById('roundMeta');
      meta.textContent = '';
      const a = document.createElement('span'); a.textContent = span || ''; meta.appendChild(a);
      if (type){ const dot = document.createElement('span'); dot.className = 'dot'; dot.textContent = type; meta.appendChild(dot); }
    }

    // ===== ACTIVE-THIS-ROUND FILTER using labeled columns =====
    const rStartCol = 'RStart';
    const rEndCol   = 'REnd';
    const activePlayersRaw = playersRaw.filter(r => {
      const start = num(r[rStartCol]); // expect integers like 1..12
      const end   = num(r[rEndCol]);
      const rr = Number(ROUND);
      // Show only players active in this round: start ≤ rr ≤ end
      return (!isNaN(start) ? start <= rr : true) && (!isNaN(end) ? end >= rr : true);
    });

    // ===== RANKING using labeled columns R8Pts, R8Perc, then Participant =====
    const ptsLabel  = 'R8Pts';
    const percLabel = 'R8Perc';

    const players = activePlayersRaw.map(r => ({
      Participant: fmt(r.Participant),
      Points: num(r[ptsLabel]),
      Percent: num(r[percLabel]),
      _last: lastName(r.Participant)
    }));

    players.sort((a,b)=>{
      // primary: R8Pts (desc)
      const pA = isNaN(a.Points) ? -Infinity : a.Points;
      const pB = isNaN(b.Points) ? -Infinity : b.Points;
      if (pA !== pB) return pB - pA;

      // secondary: R8Perc (desc)
      const qA = isNaN(a.Percent) ? -Infinity : a.Percent;
      const qB = isNaN(b.Percent) ? -Infinity : b.Percent;
      if (qA !== qB) return qB - qA;

      // tertiary: Participant (A→Z)
      return a.Participant.localeCompare(b.Participant, undefined, {sensitivity:'base'});
    });

    const rankByName = {}, nameByRank = {};
    players.forEach((p,i)=>{ p.Rank=i+1; rankByName[nameKey(p.Participant)]=p.Rank; nameByRank[p.Rank]=p.Participant; });

    // Schedule (for “no result yet” line)
    const scheduleCol = `Round ${ROUND}`;
    const scheduleMap = {};
    (scheduleRaw||[]).forEach(r=>{
      const rnk = Number(r.Ranking), opp = Number(r[scheduleCol]);
      if (!isNaN(rnk) && !isNaN(opp)) scheduleMap[rnk] = opp;
    });

    // Keep only this round if Scores CSV still carries a Round column
    const scoresRaw = (scoresRawAll||[]).filter(r => {
      const rr = Number(r.Round);
      if (isNaN(rr)) return true;
      return rr === Number(ROUND);
    });

    // Optional precomputed columns in the Scores CSV
    function parseGameTotals(row){
      if ('GamesWon' in row && 'GamesLost' in row){
        const w = safeNum(row.GamesWon), o = safeNum(row.GamesLost);
        return { wGames:w, oGames:o, diff: Math.max(0, w - o) };
      }
      const W1=safeNum(row.S1_W), O1=safeNum(row.S1_O);
      const W2=safeNum(row.S2_W), O2=safeNum(row.S2_O);
      const W3=safeNum(row.S3_W), O3=safeNum(row.S3_O);
      const TBW=safeNum(row.TB_W), TBO=safeNum(row.TB_O);
      let wGames = W1 + W2, oGames = O1 + O2;
      if (hasThirdSetTB(row)){ if (TBW > TBO){ wGames += 1; } else if (TBO > TBW){ oGames += 1; } }
      else if (W3 !== 0 || O3 !== 0){ wGames += W3; oGames += O3; }
      return { wGames, oGames, diff: Math.max(0, wGames - oGames) };
    }
    function loserBaseFromCSV(row, divisor){
      if ('LosePoints' in row){
        const base = safeNum(row.LosePoints);
        return { base, final: Math.round(base / (divisor||1)) };
      }
      const { oGames } = parseGameTotals(row);
      const base = Math.min(10, oGames);
      return { base, final: Math.round(base / (divisor||1)) };
    }
    function winnerFromCSV(row, divisor, wRank, oRank){
      if ('WinPoints' in row){
        const base = safeNum(row.WinPoints);
        return { base, final: Math.round(base / (divisor||1)) };
      }
      // fallback to site calculation (same as before)
      const rankDiff = Math.abs((oRank||0) - (wRank||0));
      const isUnderdogUpset = (wRank||99) - (oRank||0) > 1;
      const { diff } = parseGameTotals(row);
      let points;
      if (isUnderdogUpset){
        const raw = 10 + diff * ((wRank - oRank)/2);
        points = Math.max(15, Math.min(25, Math.round(raw)));
      }else{
        const raw = 10 + diff;
        points = Math.max(11, Math.round(raw));
      }
      return { base: points, final: Math.round(points / (divisor||1)) };
    }

    const scheduled = new Map();
    const challenge = new Map();

    function resultString(row, perspective){
      const winner = fmt(row.Winner), opponent = fmt(row.Opponent);
      const wRank = rankByName[nameKey(winner)] || '?';
      const oRank = rankByName[nameKey(opponent)] || '?';
      const W1 = fmt(row.S1_W), O1 = fmt(row.S1_O);
      const W2 = fmt(row.S2_W), O2 = fmt(row.S2_O);
      const set1 = `${W1}-${O1}`, set2 = `${W2}-${O2}`;
      const set3 = formatThirdEntry(row, perspective);
      return (perspective === 'winner')
        ? `Beat #${oRank} ${opponent} ${set1} ${set2}${set3}`
        : `Lost to #${wRank} ${winner} ${O1}-${W1} ${O2}-${W2}${formatThirdEntry(row, 'opponent')}`;
    }

    scoresRaw.forEach(r=>{
      const type = String(r.MatchType||'').trim();
      if (type !== 'Scheduled' && type !== 'Challenge') return;

      const winner = fmt(r.Winner), opponent = fmt(r.Opponent);
      const wKey = nameKey(winner), oKey = nameKey(opponent);
      const wRank = rankByName[wKey], oRank = rankByName[oKey];

      const winStr  = resultString(r,'winner');
      const loseStr = resultString(r,'opponent');

      const target = (type === 'Scheduled') ? scheduled : challenge;

      // winner (store)
      target.set(wKey, { text: winStr, isLoss:false, row:r, wRank, oRank });

      // loser (store)
      target.set(oKey,  { text: loseStr, isLoss:true, row:r, wRank:oRank, oRank:wRank });
    });

    // Render table
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';
    players.forEach(p=>{
      const tr = document.createElement('tr');

      const tdRank = document.createElement('td'); tdRank.className='rank'; tdRank.textContent = `#${p.Rank}`; tr.appendChild(tdRank);
      const tdName = document.createElement('td'); tdName.className='name'; tdName.textContent = p.Participant; tr.appendChild(tdName);
      const tdPts  = document.createElement('td'); tdPts.className='points'; tdPts.textContent = isNaN(p.Points)? '' : p.Points; tr.appendChild(tdPts);

      const meKey = nameKey(p.Participant);

      // Scheduled cell
      const tdSched = document.createElement('td');
      const schedRec = scheduled.get(meKey);
      if (schedRec){
        const pill = document.createElement('span'); pill.className='badge badge-scheduled'; pill.textContent='Scheduled'; tdSched.appendChild(pill);
        const span = document.createElement('span'); span.className='result ' + (schedRec.isLoss ? 'lost' : 'won'); span.textContent=schedRec.text; tdSched.appendChild(span);

        if (schedRec.isLoss){
          const { base, final } = loserBaseFromCSV(schedRec.row, 1);
          const btn = document.createElement('button');
          btn.type='button'; btn.className='loser-pts';
          btn.setAttribute('data-points', String(final));
          btn.setAttribute('data-base', String(base));
          btn.setAttribute('data-divisor', '1');
          btn.innerHTML = `<b>${final}</b> pts`;
          tdSched.appendChild(btn);
        }else{
          const win = winnerFromCSV(schedRec.row, 1, schedRec.wRank, schedRec.oRank);
          const btn = document.createElement('button');
          btn.type='button'; btn.className='winner-pts';
          btn.setAttribute('data-title','Winner Points');
          btn.setAttribute('data-points', String(win.final));
          btn.setAttribute('data-base', String(win.base));
          btn.setAttribute('data-divisor', '1');
          btn.innerHTML = `<b>${win.final}</b> pts`;
          tdSched.appendChild(btn);
        }
      }else{
        const scheduleCol = `Round ${ROUND}`;
        // build schedule map only once above; show if known
        // find p's rank again (already in name->rank map)
        const oppRank = (function(){
          // find by player rank key
          for (const [rank, name] of Object.entries(nameByRank)){
            if (name === p.Participant) return null;
          }
          return null;
        })();
        // Keep simple: if we don't have opponent mapping here, omit.
      }
      tr.appendChild(tdSched);

      // Challenge cell
      const tdChal = document.createElement('td');
      const chalRec = challenge.get(meKey);
      if (chalRec){
        const pill = document.createElement('span'); pill.className='badge badge-challenge'; pill.textContent='Challenge'; tdChal.appendChild(pill);
        const span = document.createElement('span'); span.className='result ' + (chalRec.isLoss ? 'lost' : 'won'); span.textContent=chalRec.text; tdChal.appendChild(span);

        const hasScheduled = scheduled.has(meKey);
        const divisor = hasScheduled ? 2 : 4;
        const divisorMsg = hasScheduled
          ? 'Challenge points reduced by ½ because your scheduled match was played.'
          : 'Challenge points reduced by ¼ because your scheduled match has not been played.';

        if (chalRec.isLoss){
          const { base, final } = loserBaseFromCSV(chalRec.row, divisor);
          const btn = document.createElement('button');
          btn.type='button'; btn.className='loser-pts';
          btn.setAttribute('data-points', String(final));
          btn.setAttribute('data-base', String(base));
          btn.setAttribute('data-divisor', String(divisor));
          btn.setAttribute('data-chalmsg', divisorMsg);
          btn.innerHTML = `<b>${final}</b> pts`;
          tdChal.appendChild(btn);
        }else{
          const win = winnerFromCSV(chalRec.row, divisor, chalRec.wRank, chalRec.oRank);
          const btn = document.createElement('button');
          btn.type='button'; btn.className='winner-pts';
          btn.setAttribute('data-title','Winner Points');
          btn.setAttribute('data-points', String(win.final));
          btn.setAttribute('data-base', String(win.base));
          btn.setAttribute('data-divisor', String(divisor));
          btn.setAttribute('data-chalmsg', divisorMsg);
          btn.innerHTML = `<b>${win.final}</b> pts`;
          tdChal.appendChild(btn);
        }
      }
      tr.appendChild(tdChal);

      tbody.appendChild(tr);
    });

    document.getElementById('ladder').style.display = '';
    setStatus(''); document.getElementById('status').style.display = 'none';
  }catch(err){
    console.error(err);
    setStatus('There was a problem loading your data. Double-check the CSV links and headers.', true);
  }
}

/* ============== UI: Round dropdown build & events ============== */
function buildRoundSelect(){
  const sel = document.getElementById('roundSelect');
  sel.innerHTML = '';
  for (let r=1; r<=CurrentRound; r++){
    const opt = document.createElement('option');
    opt.value = String(r);
    opt.textContent = `Round ${r}`;
    sel.appendChild(opt);
  }
  sel.value = String(ROUND);
  sel.addEventListener('change', () => {
    const r = parseInt(sel.value,10);
    if (!isNaN(r) && r>=1 && r<=CurrentRound){
      init(r);
    }
  });
}

/* Click handlers for chips -> modal (unchanged) */
document.addEventListener('click', (e)=>{
  const loserBtn = e.target.closest('.loser-pts');
  if (loserBtn){
    e.preventDefault();
    const pts = loserBtn.getAttribute('data-points') || '';
    const base = loserBtn.getAttribute('data-base') || '';
    const div  = loserBtn.getAttribute('data-divisor') || '1';
    const chal = loserBtn.getAttribute('data-chalmsg') || '';
    const baseLine = (div !== '1') ? `<p>Base points <strong>${base}</strong> ÷ ${div} ➝ <strong>${pts}</strong>.</p>` : '';
    const html = `
      <p><strong>${pts}</strong> points were awarded for this loss.</p>
      ${baseLine}
      ${chal ? `<p class="tip">${chal}</p>` : '<p class="tip">Losers receive the number of games won, but no more than 10.</p>'}
    `;
    openModal('Loser Points', html);
    return;
  }
  const winnerBtn = e.target.closest('.winner-pts');
  if (winnerBtn){
    e.preventDefault();
    const pts = winnerBtn.getAttribute('data-points') || '';
    const base = winnerBtn.getAttribute('data-base') || '';
    const div  = winnerBtn.getAttribute('data-divisor') || '1';
    const chal = winnerBtn.getAttribute('data-chalmsg') || '';
    const adjust = (div !== '1') ? `<p>Base winner points <strong>${base}</strong> ÷ ${div} ➝ <strong>${pts}</strong>.</p>` : '';
    const html = `
      <p><strong>${pts}</strong> points were awarded for this win.</p>
      ${adjust}
    `;
    openModal('Winner Points', html);
  }
});

/* Boot */
buildRoundSelect();
init(ROUND);
</script>
</body>
</html>
