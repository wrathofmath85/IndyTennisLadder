<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Indy Tennis Ladder — Rankings</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --bg:#0b0e14; --panel:#11161f; --muted:#8ea0b4; --text:#e9eef5; --rule:#253043;
    --accent:#5dd0ff; --accent-ink:#052c3a; --ok:#3bd37f; --bad:#ff6b6b;
    --chip:#1a2332; --chipBorder:#2a364a;
    --chipBlue:#173049; --chipBlueBorder:#284564;
    --chipPurple:#251e42; --chipPurpleBorder:#3b2f6a;
    --shadow: 0 20px 60px rgba(0,0,0,.45);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }
  html,body{background:linear-gradient(180deg,#0b0e14, #0b0e14 180px, #0d121b 100%); color:var(--text); min-height:100%;}
  body{ margin:24px; display:flex; justify-content:center; }
  .wrap{ width:100%; max-width:1100px; }
  header{ background:linear-gradient(180deg,#0f1521,#0d131e); border:1px solid var(--rule); border-radius:14px; padding:18px 18px 14px; box-shadow: 0 6px 30px rgba(0,0,0,.35);}
  .title{ display:flex; align-items:baseline; gap:12px; flex-wrap:wrap;}
  .title h1{ font-size:22px; margin:0; letter-spacing:.2px;}
  .round-pill{ font-size:12px; padding:4px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--chipBorder); color:var(--muted);}
  .meta{ margin-top:8px; color:var(--muted); font-size:14px; display:flex; gap:10px; flex-wrap:wrap;}
  .meta .dot::before{content:"•"; margin:0 8px; color:#3a4b66;}
  .panel{ margin-top:18px; background:var(--panel); border:1px solid var(--rule); border-radius:12px; overflow:hidden;}
  table{ width:100%; border-collapse:collapse; font-size:14px; }
  thead th{
    text-align:left; font-weight:600; color:#b9c6d8; background:#0f1521;
    border-bottom:1px solid var(--rule); padding:12px;
    position: sticky; top: 0; z-index: 2;
    box-shadow: 0 2px 0 0 var(--rule);
  }
  tbody td{ border-bottom:1px solid var(--rule); padding:12px; vertical-align:top;}
  tbody tr:hover{ background:#0e1420;}
  .rank{ width:56px; color:#cdd8e6; }
  .name{ font-weight:600;}
  .points{ font-variant-numeric: tabular-nums; }
  .result{ font-weight:600;}
  .won{ color:var(--ok); }
  .lost{ color:var(--bad); }
  .loading, .error{ margin:22px 0; padding:14px 16px; border-radius:10px; background:#0f1521; border:1px solid var(--rule); color:var(--muted);}

  .badge{ display:none; padding:2px 8px; border-radius:999px; border:1px solid var(--chipBorder);
          background:var(--chip); color:var(--muted); font-size:12px; margin-right:8px; white-space:nowrap; }
  .badge-scheduled{ background:var(--chipBlue); border-color:var(--chipBlueBorder); }
  .badge-challenge{ background:var(--chipPurple); border-color:var(--chipPurpleBorder); }

  /* Loser & Winner points chips */
  .loser-pts, .winner-pts{
    display:inline-flex; align-items:center; gap:6px;
    margin-left:10px; padding:2px 8px; border-radius:999px;
    font-size:12px; cursor:pointer; user-select:none;
  }
  .loser-pts{ background:#1a2230; border:1px solid #2a3548; color:#bcd0e5; }
  .winner-pts{ background:#12261b; border:1px solid #284c37; color:#c9edd7; }
  .loser-pts b, .winner-pts b{ font-variant-numeric:tabular-nums; color:#e9eef5; }

  /* Modal */
  .backdrop{
    position:fixed; inset:0; background:rgba(8,12,20,.55);
    opacity:0; pointer-events:none; transition:opacity .15s ease;
  }
  .backdrop.show{ opacity:1; pointer-events:auto; }
  .modal{
    position:fixed; left:50%; top:50%;
    transform:translate(-50%,-46%) scale(.98);
    background:#0f1521; border:1px solid var(--rule);
    border-radius:16px; box-shadow:var(--shadow);
    width:min(92vw,560px);
    opacity:0; transition:opacity .15s ease, transform .18s ease;
  }
  .modal.show{ opacity:1; transform:translate(-50%,-50%) scale(1); }
  .modal-header{
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px; border-bottom:1px solid var(--rule);
    background:#11192a; border-top-left-radius:16px; border-top-right-radius:16px;
  }
  .modal-title{ font-weight:700; font-size:18px; letter-spacing:.2px; }
  .modal-close{
    appearance:none; border:1px solid #334258; background:#1a2436; color:#c9d6e6;
    border-radius:8px; width:28px; height:28px; font-size:16px; line-height:26px;
    text-align:center; cursor:pointer;
  }
  .modal-body{ padding:16px; color:#d2deee; }
  .modal-body p{ margin:0 0 8px 0; line-height:1.5; }
  .modal-body .tip{
    margin-top:10px; font-size:13px; color:#93a6bf;
    border-top:1px dashed #2a3750; padding-top:10px;
  }

  .footer-note{ color:#6e7f98; font-size:12px; margin-top:10px; }

  @media (max-width:720px){
    thead{ display:none; }
    table, tbody, tr, td{ display:block; width:100%; }
    tbody tr{ padding:12px 12px 6px; }
    tbody td{ border:0; padding:4px 0; }
    .rank{ order:-3; font-weight:700; }
    .name{ order:-2; font-size:16px; }
    .points{ order:-1; }
    .badge{ display:inline-block; }
    .loser-pts,.winner-pts{ margin-left:0; margin-top:6px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>Indy Tennis Ladder</h1>
      <span class="round-pill" id="roundPill">Round 1</span>
    </div>
    <div class="meta" id="roundMeta"></div>
  </header>

  <div class="panel">
    <div class="loading" id="status">Loading data…</div>
    <table id="ladder" style="display:none;">
      <thead>
        <tr>
          <th class="rank">#</th>
          <th>Participant</th>
          <th class="points">Points</th>
          <th>Scheduled Opponent / Result</th>
          <th>Challenge Opponent / Result</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="footer-note">Tip: Add <code>?round=2</code> to the page URL while testing different rounds.</div>
</div>

<!-- Modal -->
<div class="backdrop" id="backdrop" aria-hidden="true"></div>
<div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="modal-header">
    <div class="modal-title" id="modalTitle">Points</div>
    <button class="modal-close" id="modalClose" aria-label="Close">×</button>
  </div>
  <div class="modal-body" id="modalBody"></div>
</div>

<script>
/* ============== CONFIG ============== */
const CSV = {
  Players: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=0&single=true&output=csv',
  Scores:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=551333593&single=true&output=csv',
  Schedule:'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1596015267&single=true&output=csv',
  Dates:   'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=838168726&single=true&output=csv'
};

// Active round: override via ?round=#
const ROUND = (() => {
  const u = new URLSearchParams(location.search);
  const q = parseInt(u.get('round'),10);
  if (!isNaN(q) && q>=1 && q<=10) return q;
  return 1;
})();
document.getElementById('roundPill').textContent = `Round ${ROUND}`;

/* ============== HELPERS ============== */
function loadCSV(url){
  return new Promise((resolve, reject) => {
    Papa.parse(url, { download: true, header: true, skipEmptyLines: 'greedy',
      complete: (res) => resolve(res.data || []),
      error: (err) => reject(err)
    });
  });
}

const nameKey = s => String(s||'').trim().toLowerCase();
const lastName = s => {
  const parts = String(s||'').trim().split(/\s+/);
  return parts.length ? parts[parts.length-1] : '';
};
const num = v => (v===null || v===undefined || v==='') ? NaN : +String(v).toString().replace(/[% ,]/g,'');
const safeNum = v => { const n = num(v); return isNaN(n)?0:n; };
const fmt = (v) => v===undefined || v===null ? '' : String(v);

function fmtDateRange(startRaw, endRaw){
  const tryParse = (val) => {
    if (val === undefined || val === null || val === '') return null;
    if (/^\d+(\.\d+)?$/.test(String(val))) {
      const days = Number(val);
      const base = new Date(Date.UTC(1899,11,30));
      return new Date(base.getTime() + days*86400000);
    }
    const d = new Date(val);
    return isNaN(d) ? null : d;
  };
  const s = tryParse(startRaw), e = tryParse(endRaw);
  const nice = (d) => d.toLocaleDateString(undefined, {month:'short', day:'numeric'});
  if (s && e) return `${nice(s)} – ${nice(e)}`;
  if (s) return nice(s);
  if (e) return nice(e);
  return [fmt(startRaw), fmt(endRaw)].filter(Boolean).join(' – ');
}

function setStatus(msg, isError=false){
  const st = document.getElementById('status');
  st.textContent = msg;
  st.className = isError ? 'error' : 'loading';
}

/* Modal helpers */
const backdropEl = document.getElementById('backdrop');
const modalEl = document.getElementById('modal');
const modalBody = document.getElementById('modalBody');
const modalTitle = document.getElementById('modalTitle');
document.getElementById('modalClose').addEventListener('click', closeModal);
backdropEl.addEventListener('click', closeModal);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
function openModal(title, html){
  modalTitle.textContent = title || 'Info';
  modalBody.innerHTML = html;
  backdropEl.classList.add('show');
  modalEl.classList.add('show');
  backdropEl.setAttribute('aria-hidden','false');
  modalEl.setAttribute('aria-hidden','false');
}
function closeModal(){
  modalEl.classList.remove('show');
  backdropEl.classList.remove('show');
  backdropEl.setAttribute('aria-hidden','true');
  modalEl.setAttribute('aria-hidden','true');
}

/* ============== CORE LOGIC ============== */
async function init(){
  try{
    setStatus('Loading data…');

    const [playersRaw, scoresRaw, scheduleRaw, datesRaw] = await Promise.all([
      loadCSV(CSV.Players),
      loadCSV(CSV.Scores),
      loadCSV(CSV.Schedule),
      loadCSV(CSV.Dates)
    ]);

    // Dates header
    const roundRow = datesRaw.find(r => Number(r.Round) === Number(ROUND));
    if (roundRow){
      const span = fmtDateRange(roundRow.Start, roundRow.End);
      const type = fmt(roundRow.Type);
      const meta = document.getElementById('roundMeta');
      meta.textContent = '';
      const a = document.createElement('span');
      a.textContent = span || '';
      meta.appendChild(a);
      if (type){
        const dot = document.createElement('span'); dot.className = 'dot';
        dot.textContent = type;
        meta.appendChild(dot);
      }
    }

    // ---------- FILTER BY ACTIVE ROUND ----------
    const getBound = (row, keys, defVal) => {
      for (const k of keys){
        if (row.hasOwnProperty(k) && row[k] !== '') {
          const v = num(row[k]);
          if (!isNaN(v)) return v;
        }
      }
      return defVal;
    };
    const activePlayersRaw = playersRaw.filter(r => {
      const start = getBound(r, ['ROUNDSTART','RoundStart','ROUND START','StartRound','Start'], -Infinity);
      const end   = getBound(r, ['ROUNDEND','RoundEnd','ROUND END','EndRound','End'], Infinity);
      const rr = Number(ROUND);
      return start <= rr && end >= rr;
    });

    // Build ranking from ACTIVE players only
    const pointsCol = `Round${ROUND}Points`;
    const pctCol    = `Round${ROUND}Percent`;

    const players = activePlayersRaw.map(r => ({
      Participant: fmt(r.Participant),
      Points: num(r[pointsCol]),
      Percent: num(r[pctCol]),
      _last: lastName(r.Participant)
    }));

    players.sort((a,b)=>{
      const p = (isNaN(a.Points)?-Infinity:a.Points) - (isNaN(b.Points)?-Infinity:b.Points);
      if (p!==0) return p>0 ? -1 : 1;
      const q = (isNaN(a.Percent)?-Infinity:a.Percent) - (isNaN(b.Percent)?-Infinity:b.Percent);
      if (q!==0) return q>0 ? -1 : 1;
      return a._last.localeCompare(b._last, undefined, {sensitivity:'base'});
    });

    const rankByName = {};
    const nameByRank = {};
    players.forEach((p,i)=>{ p.Rank=i+1; rankByName[nameKey(p.Participant)]=p.Rank; nameByRank[p.Rank]=p.Participant; });

    // Schedule map
    const scheduleCol = `Round ${ROUND}`;
    const scheduleMap = {};
    scheduleRaw.forEach(r=>{
      const rnk = Number(r.Ranking), opp = Number(r[scheduleCol]);
      if (!isNaN(rnk) && !isNaN(opp)) scheduleMap[rnk] = opp;
    });

    // ------- Score helpers -------
    function parseGameTotals(row){
      const W1=safeNum(row.S1_W), O1=safeNum(row.S1_O);
      const W2=safeNum(row.S2_W), O2=safeNum(row.S2_O);
      const W3=safeNum(row.S3_W), O3=safeNum(row.S3_O);
      const wGames = W1+W2+W3;
      const oGames = O1+O2+O3;
      return { wGames, oGames, diff: Math.max(0, wGames - oGames) };
    }
    function computeWinnerPoints(winnerRank, opponentRank, diffGames){
      const rankDiff = Math.abs((opponentRank||0) - (winnerRank||0));
      const isUnderdogUpset = (winnerRank||99) - (opponentRank||0) > 1; // winner had worse (larger) rank by >1
      let points, rule;
      if (isUnderdogUpset){
        const raw = 10 + diffGames * ((winnerRank - opponentRank)/2);
        points = Math.max(15, Math.min(25, Math.round(raw)));
        rule = `Underdog upset: 10 + (games diff × rank diff / 2), min 15, max 25`;
      }else{
        const raw = 10 + diffGames;
        points = Math.max(11, Math.round(raw));
        rule = `Standard: 10 + games diff, minimum 11`;
      }
      return { points, rule, rankDiff, diffGames, isUnderdogUpset };
    }
    // Loser base points (computed from scores): games won, capped at 10
    function computeLoserBasePoints(row){
      const { oGames } = parseGameTotals(row); // opponent is the loser in the row
      return Math.min(10, oGames);
    }

    // Index results (now computing loser points from scores)
    const scheduledByPlayer = new Map();
    const challengeByPlayer = new Map();
    const scheduledLoserPts = new Map();   // key -> base number (from scores)
    const challengeLoserPts = new Map();   // key -> base number (from scores)
    const scheduledWinnerMeta = new Map();
    const challengeWinnerMeta = new Map();

    function resultString(row, perspective){
      const winner = fmt(row.Winner), opponent = fmt(row.Opponent);
      const wRank = rankByName[nameKey(winner)] || '?';
      const oRank = rankByName[nameKey(opponent)] || '?';
      const W1 = fmt(row.S1_W), O1 = fmt(row.S1_O);
      const W2 = fmt(row.S2_W), O2 = fmt(row.S2_O);
      const W3 = fmt(row.S3_W), O3 = fmt(row.S3_O);
      const set1 = `${W1}-${O1}`, set2 = `${W2}-${O2}`, set3 = (W3!=='' || O3!=='') ? ` ${W3}-${O3}` : '';
      return (perspective === 'winner')
        ? `Beat #${oRank} ${opponent} ${set1} ${set2}${set3}`
        : `Lost to #${wRank} ${winner} ${O1}-${W1} ${O2}-${W2}${(W3!==''||O3!=='')?` ${O3}-${W3}`:''}`;
    }

    scoresRaw.forEach(r=>{
      const rRound = Number(r.Round);
      if (rRound !== Number(ROUND)) return;
      const type = String(r.MatchType||'').trim();
      if (type !== 'Scheduled' && type !== 'Challenge') return;

      const winner = fmt(r.Winner), opponent = fmt(r.Opponent);
      const wKey = nameKey(winner), oKey = nameKey(opponent);
      const wRank = rankByName[wKey], oRank = rankByName[oKey];

      const winStr = resultString(r,'winner');
      const loseStr = resultString(r,'opponent');

      const { diff } = parseGameTotals(r);
      const wMeta = computeWinnerPoints(wRank, oRank, diff);    // BASE winner points
      const loserBase = computeLoserBasePoints(r);              // BASE loser points (from scores)

      if (type==='Scheduled'){
        if (!scheduledByPlayer.has(wKey)) scheduledByPlayer.set(wKey, winStr);
        if (!scheduledByPlayer.has(oKey)) scheduledByPlayer.set(oKey, loseStr);
        scheduledLoserPts.set(oKey, loserBase);
        scheduledWinnerMeta.set(wKey, { ...wMeta, opponentRank:oRank, winnerRank:wRank });
      }else{
        if (!challengeByPlayer.has(wKey)) challengeByPlayer.set(wKey, winStr);
        if (!challengeByPlayer.has(oKey)) challengeByPlayer.set(oKey, loseStr);
        challengeLoserPts.set(oKey, loserBase);
        challengeWinnerMeta.set(wKey, { ...wMeta, opponentRank:oRank, winnerRank:wRank });
      }
    });

    // Render table
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';

    players.forEach(p=>{
      const tr = document.createElement('tr');

      const tdRank = document.createElement('td');
      tdRank.className = 'rank';
      tdRank.textContent = `#${p.Rank}`;
      tr.appendChild(tdRank);

      const tdName = document.createElement('td');
      tdName.className = 'name';
      tdName.textContent = p.Participant;
      tr.appendChild(tdName);

      const tdPts = document.createElement('td');
      tdPts.className = 'points';
      tdPts.textContent = isNaN(p.Points) ? '' : p.Points;
      tr.appendChild(tdPts);

      const meKey = nameKey(p.Participant);

      // Scheduled cell (no division)
      const tdSched = document.createElement('td');
      const schedRes = scheduledByPlayer.get(meKey);
      if (schedRes){
        const pill = document.createElement('span');
        pill.className = 'badge badge-scheduled';
        pill.textContent = 'Scheduled';
        tdSched.appendChild(pill);

        const span = document.createElement('span');
        const isLoss = schedRes.startsWith('Lost');
        span.className = 'result ' + (isLoss ? 'lost' : 'won');
        span.textContent = schedRes;
        tdSched.appendChild(span);

        if (isLoss && scheduledLoserPts.has(meKey)){
          const base = scheduledLoserPts.get(meKey);     // from scores
          const finalPts = Math.round(base);             // scheduled => no divisor
          const badge = document.createElement('button');
          badge.type='button'; badge.className='loser-pts';
          badge.setAttribute('data-info','Losers receive the number of games won, but no more than 10');
          badge.setAttribute('data-points', String(finalPts));
          badge.setAttribute('data-base', String(base));
          badge.setAttribute('data-divisor', '1');
          badge.innerHTML = `<b>${finalPts}</b> pts`;
          tdSched.appendChild(badge);
        }else if(!isLoss && scheduledWinnerMeta.has(meKey)){
          const wm = scheduledWinnerMeta.get(meKey);
          const badge = document.createElement('button');
          badge.type='button'; badge.className='winner-pts';
          badge.setAttribute('data-title','Winner Points');
          badge.setAttribute('data-points', String(wm.points));
          badge.setAttribute('data-base', String(wm.points));
          badge.setAttribute('data-divisor', '1');
          badge.setAttribute('data-rule', wm.rule);
          badge.setAttribute('data-rdiff', String(wm.rankDiff));
          badge.setAttribute('data-gdiff', String(wm.diffGames));
          badge.innerHTML = `<b>${wm.points}</b> pts`;
          tdSched.appendChild(badge);
        }
      }else{
        const oppRank = scheduleMap[p.Rank];
        if (oppRank){
          const oppName = nameByRank[oppRank] || '';
          const span = document.createElement('span');
          span.innerHTML = `<span class="badge badge-scheduled">Scheduled</span> #${oppRank} ${oppName || ''}`;
          tdSched.appendChild(span);
        }
      }
      tr.appendChild(tdSched);

      // Challenge cell (apply division rule)
      const tdChal = document.createElement('td');
      const chalRes = challengeByPlayer.get(meKey);
      if (chalRes){
        const pill = document.createElement('span');
        pill.className = 'badge badge-challenge';
        pill.textContent = 'Challenge';
        tdChal.appendChild(pill);

        const span = document.createElement('span');
        const isLoss = chalRes.startsWith('Lost');
        span.className = 'result ' + (isLoss ? 'lost' : 'won');
        span.textContent = chalRes;
        tdChal.appendChild(span);

        // Determine divisor based on whether scheduled match was played
        const hasScheduledMatch = scheduledByPlayer.has(meKey);
        const divisor = hasScheduledMatch ? 2 : 4;
        const divisorMsg = hasScheduledMatch
          ? 'Challenge points reduced by ½ because your scheduled match was played.'
          : 'Challenge points reduced by ¼ because your scheduled match has not been played.';

        if (isLoss && challengeLoserPts.has(meKey)){
          const base = challengeLoserPts.get(meKey);     // from scores
          const finalPts = Math.round(base / divisor);
          const badge = document.createElement('button');
          badge.type='button'; badge.className='loser-pts';
          badge.setAttribute('data-info','Losers receive the number of games won, but no more than 10');
          badge.setAttribute('data-points', String(finalPts));
          badge.setAttribute('data-base', String(base));
          badge.setAttribute('data-divisor', String(divisor));
          badge.setAttribute('data-chalmsg', divisorMsg);
          badge.innerHTML = `<b>${finalPts}</b> pts`;
          tdChal.appendChild(badge);
        }else if(!isLoss && challengeWinnerMeta.has(meKey)){
          const wm = challengeWinnerMeta.get(meKey);
          const finalPts = Math.round(wm.points / divisor);
          const badge = document.createElement('button');
          badge.type='button'; badge.className='winner-pts';
          badge.setAttribute('data-title','Winner Points');
          badge.setAttribute('data-points', String(finalPts));
          badge.setAttribute('data-base', String(wm.points));
          badge.setAttribute('data-divisor', String(divisor));
          badge.setAttribute('data-rule', wm.rule);
          badge.setAttribute('data-rdiff', String(wm.rankDiff));
          badge.setAttribute('data-gdiff', String(wm.diffGames));
          badge.setAttribute('data-chalmsg', divisorMsg);
          badge.innerHTML = `<b>${finalPts}</b> pts`;
          tdChal.appendChild(badge);
        }
      }
      tr.appendChild(tdChal);

      tbody.appendChild(tr);
    });

    document.getElementById('ladder').style.display = '';
    setStatus('');
    document.getElementById('status').style.display = 'none';

  }catch(err){
    console.error(err);
    setStatus('There was a problem loading your data. Double-check the CSV links and headers.', true);
  }
}

/* Click handlers for chips -> modal */
document.addEventListener('click', (e)=>{
  const loserBtn = e.target.closest('.loser-pts');
  if (loserBtn){
    e.preventDefault();
    const pts = loserBtn.getAttribute('data-points') || '';
    const base = loserBtn.getAttribute('data-base') || '';
    const div  = loserBtn.getAttribute('data-divisor') || '1';
    const chal = loserBtn.getAttribute('data-chalmsg') || '';
    const baseLine = (div !== '1') ? `<p>Base points <strong>${base}</strong> ÷ ${div} ➝ <strong>${pts}</strong>.</p>` : '';
    const html = `
      <p><strong>${pts}</strong> points were awarded for this loss.</p>
      ${baseLine}
      ${chal ? `<p class="tip">${chal}</p>` : '<p class="tip">Losers receive the number of games won, but no more than 10.</p>'}
    `;
    openModal('Loser Points', html);
    return;
  }
  const winnerBtn = e.target.closest('.winner-pts');
  if (winnerBtn){
    e.preventDefault();
    const pts = winnerBtn.getAttribute('data-points') || '';
    const base = winnerBtn.getAttribute('data-base') || '';
    const rule = winnerBtn.getAttribute('data-rule') || '';
    const rdiff = winnerBtn.getAttribute('data-rdiff') || '';
    const gdiff = winnerBtn.getAttribute('data-gdiff') || '';
    const div  = winnerBtn.getAttribute('data-divisor') || '1';
    const chal = winnerBtn.getAttribute('data-chalmsg') || '';
    const adjust = (div !== '1') ? `<p>Base winner points <strong>${base}</strong> (rule below) ÷ ${div} ➝ <strong>${pts}</strong>.</p>` : '';
    const html = `
      <p><strong>${pts}</strong> points were awarded for this win.</p>
      ${adjust}
      <p>Inputs: rank difference <strong>${rdiff}</strong>, games difference <strong>${gdiff}</strong>.</p>
      <p class="tip"><em>${rule}</em></p>
      ${chal ? `<p class="tip">${chal}</p>` : ''}`;
    openModal('Winner Points', html);
  }
});

init();
</script>
</body>
</html>
