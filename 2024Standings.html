<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Indy Tennis Ladder — Rankings</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --bg:#0b0e14; --panel:#11161f; --muted:#8ea0b4; --text:#e9eef5; --rule:#253043;
    --accent:#5dd0ff; --accent-ink:#052c3a; --ok:#3bd37f; --bad:#ff6b6b;
    --chip:#1a2332; --chipBorder:#2a364a;
    --chipBlue:#173049; --chipBlueBorder:#284564;
    --chipPurple:#251e42; --chipPurpleBorder:#3b2f6a;
    --shadow: 0 20px 60px rgba(0,0,0,.45);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }
  html,body{background:linear-gradient(180deg,#0b0e14, #0b0e14 180px, #0d121b 100%); color:var(--text); min-height:100%;}
  body{ margin:24px; display:flex; justify-content:center; }
  .wrap{ width:100%; max-width:1100px; }

  header{
    background:linear-gradient(180deg,#0f1521,#0d131e);
    border:1px solid var(--rule);
    border-radius:14px;
    padding:18px 18px 14px;
    box-shadow: var(--shadow);
  }
  .title{ display:flex; align-items:baseline; gap:12px; flex-wrap:wrap;}
  .title h1{ font-size:22px; margin:0; letter-spacing:.2px;}
  .round-select{
    appearance:none; font-size:12px; padding:6px 28px 6px 10px;
    border-radius:999px; background:var(--chip); border:1px solid var(--chipBorder);
    color:var(--muted); cursor:pointer;
  }
  .meta{ margin-top:8px; color:var(--muted); font-size:14px; display:flex; gap:10px; flex-wrap:wrap;}
  .meta .dot::before{content:"•"; margin:0 8px; color:#3a4b66;}

  .panel{
    margin-top:18px;
    background:var(--panel);
    border:1px solid var(--rule);
    border-radius:12px;
    overflow:auto;
    -webkit-overflow-scrolling:touch;
  }

  table{
    width:100%;
    min-width:980px;
    border-collapse:collapse;
    font-size:14px;
    table-layout:auto;
  }

  thead th{
    text-align:left;
    font-weight:600;
    color:#b9c6d8;
    background:#0f1521;
    border-bottom:1px solid var(--rule);
    padding:12px;
    position:sticky;
    top:0;
    z-index:2;
    box-shadow:0 2px 0 0 var(--rule);
    white-space:nowrap;
  }

  tbody td{
    border-bottom:1px solid var(--rule);
    padding:12px;
    vertical-align:middle;
    white-space:nowrap;
  }
  tbody tr:hover{ background:#0e1420;}

  .rank{ width:150px; color:#cdd8e6; font-variant-numeric: tabular-nums; }
  .points{ width:90px; font-variant-numeric: tabular-nums; }
  .rank.current{ width:130px; }

  /* Participant cell now 2 lines (desktop) */
  .name{ font-weight:700; }
  .phone{
    display:block;
    margin-top:4px;
    font-weight:600;
    font-size:12px;
    color:var(--muted);
    letter-spacing:.2px;
  }

  /* Mobile-only header inside participant cell */
  .m-head{ display:none; align-items:baseline; gap:10px; }
  .m-rank{
    font-weight:900;
    font-variant-numeric: tabular-nums;
    color:#cdd8e6;
    flex:0 0 auto;
  }
  .m-name{
    font-weight:900;
    color:#e9eef5;
    min-width:0;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }

  .result{ font-weight:600; }
  .won{ color:var(--ok); }
  .lost{ color:var(--bad); }

  .loading, .error{
    margin:22px 0; padding:14px 16px; border-radius:10px;
    background:#0f1521; border:1px solid var(--rule); color:#8ea0b4;
  }

  .badge{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid var(--chipBorder);
    background:var(--chip);
    color:var(--muted);
    font-size:12px;
    margin-right:8px;
    white-space:nowrap;
    flex:0 0 auto;
  }
  .badge-scheduled{ background:var(--chipBlue); border-color:var(--chipBlueBorder); }
  .badge-challenge{ background:var(--chipPurple); border-color:var(--chipPurpleBorder); }

  .winner-pts, .loser-pts{
    display:inline-flex; align-items:center; gap:6px;
    margin-left:10px; padding:2px 8px; border-radius:999px; font-size:12px;
    cursor:pointer; user-select:none;
    position:relative; z-index:3; pointer-events:auto;
    white-space:nowrap;
  }
  .loser-pts{ background:#1a2230; border:1px solid #2a3548; color:#bcd0e5; }
  .winner-pts{ background:#12261b; border:1px solid #284c37; color:#c9edd7; }
  .loser-pts b,.winner-pts b{ font-variant-numeric:tabular-nums; color:#e9eef5; }

  .result, .badge{ position:relative; z-index:1; }
  .panel table *{ pointer-events:auto; }

  .matches{
    white-space:nowrap;
    min-width:520px;
  }
  .match-line{
    display:flex;
    align-items:center;
    gap:8px;
    min-height:26px;
  }
  .match-line.empty{
    opacity:.0; /* keep height but show “nothing” on desktop */
  }

  /* Mobile-only stats line */
  .m-stats{
    display:none;
    margin-top:10px;
    padding-top:10px;
    border-top:1px dashed #23324a;
    color:var(--muted);
    font-size:13px;
    white-space:nowrap;
    gap:14px;
    align-items:center;
  }
  .m-stats b{
    color:#e9eef5;
    font-variant-numeric: tabular-nums;
  }

  .backdrop{
    position:fixed; inset:0; background:rgba(8,12,20,.55);
    opacity:0; pointer-events:none; transition:opacity .15s ease;
    z-index:10000;
  }
  .backdrop.show{ opacity:1; pointer-events:auto; }

  .modal{
    position:fixed; left:50%; top:50%;
    transform:translate(-50%,-46%) scale(.98);
    background:#0f1521; border:1px solid var(--rule);
    border-radius:16px; box-shadow:var(--shadow);
    width:min(92vw,560px); opacity:0;
    transition:opacity .15s ease, transform .18s ease;
    z-index:10001;
  }
  .modal.show{ opacity:1; transform:translate(-50%,-50%) scale(1); }
  .modal-header{
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px; border-bottom:1px solid var(--rule);
    background:#11192a; border-top-left-radius:16px; border-top-right-radius:16px;
  }
  .modal-title{ font-weight:700; font-size:18px; letter-spacing:.2px; }
  .modal-close{
    appearance:none; border:1px solid #334258; background:#1a2436; color:#c9d6e6;
    border-radius:8px; width:28px; height:28px; font-size:16px; line-height:26px;
    text-align:center; cursor:pointer;
  }
  .modal-body{ padding:16px; color:#d2deee; }
  .modal-body p{ margin:0 0 8px 0; line-height:1.5; }
  .modal-body .tip{ margin-top:10px; font-size:13px; color:#93a6bf; border-top:1px dashed #2a3750; padding-top:10px; }
  .footer-note{ color:#6e7f98; font-size:12px; margin-top:10px; }

  /* ===== Mobile layout changes (desktop unchanged) ===== */
  @media (max-width:720px){
    thead{ display:none; }
    table,tbody,tr,td{ display:block; width:100%; min-width:0; }
    .panel{ overflow:visible; }

    /* Stronger separation between people */
    tbody tr{
      padding:14px 12px;
      border-bottom:1px solid var(--rule);
      background:transparent;
    }
    tbody tr:hover{ background:transparent; }

    tbody td{
      border:0;
      padding:6px 0;
      white-space:normal;
    }

    /* Hide the standalone begin-rank column on mobile (we'll show it next to the name) */
    .rank-begin{ display:none; }

    /* Show our combined "rank + name" header line; hide the desktop name line */
    .m-head{ display:flex; }
    .name{ display:none; }

    /* Keep matches below */
    .matches{ order:2; min-width:0; }

    /* Hide the separate Points and Current Rank columns */
    .points{ display:none; }
    .rank-current{ display:none; }

    /* Show the combined stats line (Points + Current Rank) */
    .m-stats{ display:flex; }

    .winner-pts,.loser-pts{ margin-left:0; margin-top:6px; }
    .match-line.empty{ display:none; } /* mobile: truly “show nothing” */
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>Indy Tennis Ladder</h1>
      <select id="roundSelect" class="round-select" aria-label="Select round"></select>
    </div>
    <div class="meta" id="roundMeta"></div>
  </header>

  <div class="panel">
    <div class="loading" id="status">Loading data…</div>
    <table id="ladder" style="display:none;">
      <thead>
        <tr>
          <th class="rank" id="thRoundRank">Round 1 Ranking</th>
          <th>Participant</th>
          <th class="matches">Result</th>
          <th class="points">Points</th>
          <th class="rank current">Current Ranking</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="footer-note">Tip: you can also use <code>?round=2</code> while testing.</div>
</div>

<div class="backdrop" id="backdrop" aria-hidden="true"></div>
<div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="modal-header">
    <div class="modal-title" id="modalTitle">Info</div>
    <button class="modal-close" id="modalClose" aria-label="Close">×</button>
  </div>
  <div class="modal-body" id="modalBody"></div>
</div>

<script>
/* ===== CONFIG ===== */
const CurrentRound = 2;

const CSV = {
  Players:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=0&single=true&output=csv',
  Schedule: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1596015267&single=true&output=csv',
  Dates:    'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=838168726&single=true&output=csv',
  ScoresRound1:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1813586077&single=true&output=csv',
  ScoresRound2:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=667416587&single=true&output=csv',
  ScoresRound3:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1340896382&single=true&output=csv',
  ScoresRound4:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1779797386&single=true&output=csv',
  ScoresRound5:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1138515130&single=true&output=csv',
  ScoresRound6:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=2117392535&single=true&output=csv',
  ScoresRound7:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=454354939&single=true&output=csv',
  ScoresRound8:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1429948565&single=true&output=csv',
  ScoresRound9:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=656808017&single=true&output=csv',
  ScoresRound10: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaB85nmIHBvdq3f8PKp-9T0TwMrKC6pYKOkZIUbt11daYCpFyxLCOhBTykQ2iqypQDqwTTnxZiOPuy/pub?gid=1886048839&single=true&output=csv'
};

let ROUND = (() => {
  const u = new URLSearchParams(location.search);
  const q = parseInt(u.get('round'), 10);
  if (!isNaN(q) && q >= 1 && q <= CurrentRound) return q;
  return CurrentRound;
})();

/* ===== Helpers ===== */
function loadCSV(url){
  return new Promise((resolve, reject) => {
    if (!url) return resolve([]);
    Papa.parse(url, { download: true, header: true, skipEmptyLines: 'greedy',
      complete: (res) => resolve(res.data || []),
      error: (err) => reject(err)
    });
  });
}
const nameKey = s => String(s||'').trim().toLowerCase();
const num = v => (v===null || v===undefined || v==='') ? NaN : +String(v).toString().replace(/[% ,]/g,'');
const safeNum = v => { const n = num(v); return isNaN(n)?0:n; };
const fmt = (v) => v===undefined || v===null ? '' : String(v);

function fmtDateRange(startRaw, endRaw){
  const tryParse = (val) => {
    if (val === undefined || val === null || val === '') return null;
    if (/^\d+(\.\d+)?$/.test(String(val))) {
      const days = Number(val);
      const base = new Date(Date.UTC(1899,11,30));
      return new Date(base.getTime() + days*86400000);
    }
    const d = new Date(val);
    return isNaN(d) ? null : d;
  };
  const s = tryParse(startRaw), e = tryParse(endRaw);
  const nice = (d) => d.toLocaleDateString(undefined, {month:'short', day:'numeric'});
  if (s && e) return `${nice(s)} – ${nice(e)}`;
  if (s) return nice(s);
  if (e) return nice(e);
  return [fmt(startRaw), fmt(endRaw)].filter(Boolean).join(' – ');
}
function setStatus(msg, isError=false){
  const st = document.getElementById('status');
  st.textContent = msg;
  st.className = isError ? 'error' : 'loading';
}

/* Modal helpers */
const backdropEl = document.getElementById('backdrop');
const modalEl = document.getElementById('modal');
const modalBody = document.getElementById('modalBody');
const modalTitle = document.getElementById('modalTitle');
document.getElementById('modalClose').addEventListener('click', closeModal);
backdropEl.addEventListener('click', closeModal);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
function openModal(title, html){
  modalTitle.textContent = title || 'Info';
  modalBody.innerHTML = html;
  backdropEl.classList.add('show'); modalEl.classList.add('show');
  backdropEl.setAttribute('aria-hidden','false'); modalEl.setAttribute('aria-hidden','false');
  document.documentElement.style.overflow = 'hidden';
  document.body.style.overflow = 'hidden';
}
function closeModal(){
  modalEl.classList.remove('show'); backdropEl.classList.remove('show');
  backdropEl.setAttribute('aria-hidden','true'); modalEl.setAttribute('aria-hidden','true');
  document.documentElement.style.overflow = '';
  document.body.style.overflow = '';
}

/* Tennis helpers */
function hasThirdSetTB(row){ return fmt(row.TB_W) !== '' || fmt(row.TB_O) !== ''; }
function parseGameTotals(row){
  if ('GamesWon' in row && 'GamesLost' in row){
    const w = safeNum(row.GamesWon), o = safeNum(row.GamesLost);
    return { wGames:w, oGames:o, diff: Math.max(0, w - o) };
  }
  const W1=safeNum(row.S1_W), O1=safeNum(row.S1_O);
  const W2=safeNum(row.S2_W), O2=safeNum(row.S2_O);
  const W3=safeNum(row.S3_W), O3=safeNum(row.S3_O);
  const TBW=safeNum(row.TB_W), TBO=safeNum(row.TB_O);
  let wGames = W1 + W2, oGames = O1 + O2;
  if (hasThirdSetTB(row)){ if (TBW > TBO){ wGames += 1; } else if (TBO > TBW){ oGames += 1; } }
  else if (W3 !== 0 || O3 !== 0){ wGames += W3; oGames += O3; }
  return { wGames, oGames, diff: Math.max(0, wGames - oGames) };
}
function formatThirdEntry(row, perspective){
  if (!hasThirdSetTB(row)){
    const W3 = fmt(row.S3_W), O3 = fmt(row.S3_O);
    if (W3 === '' && O3 === '') return '';
    return perspective === 'winner' ? ` ${W3}-${O3}` : ` ${O3}-${W3}`;
  }
  const a = fmt(row.TB_W), b = fmt(row.TB_O);
  if (a === '' && b === '') return '';
  return perspective === 'winner' ? ` ${a}-${b}` : ` ${b}-${a}`;
}

/* Status helpers */
function statusText(row){
  return String(row.Status || row.STATUS || '').trim();
}
function isWalkoverStatus(row){
  const s = statusText(row).toLowerCase();
  return s === 'walkover' || s === 'wo' || s === 'w/o' || s.includes('walkover');
}
function isRetiredStatus(row){
  const s = statusText(row).toLowerCase();
  return s === 'retired' || s === 'ret' || s.includes('retired');
}

/* Result string: walkover replaces score; retired appends " Ret" to score */
function resultString(row, perspective, beginRankByName){
  const winner = fmt(row.Winner), opponent = fmt(row.Opponent);
  const wRank = beginRankByName[nameKey(winner)] || '?';
  const oRank = beginRankByName[nameKey(opponent)] || '?';

  const walkover = isWalkoverStatus(row);
  const retired  = isRetiredStatus(row);

  let scorePart;
  if (walkover){
    scorePart = 'walkover';
  } else {
    const W1 = fmt(row.S1_W), O1 = fmt(row.S1_O);
    const W2 = fmt(row.S2_W), O2 = fmt(row.S2_O);
    const set1 = `${W1}-${O1}`, set2 = `${W2}-${O2}`;
    const set3 = formatThirdEntry(row, perspective);

    scorePart = (perspective === 'winner')
      ? `${set1} ${set2}${set3}`
      : `${O1}-${W1} ${O2}-${W2}${formatThirdEntry(row, 'opponent')}`;

    if (retired) scorePart += ' Ret';
  }

  return (perspective === 'winner')
    ? `Beat #${oRank} ${opponent} ${scorePart}`
    : `Lost to #${wRank} ${winner} ${scorePart}`;
}

/* ===== Core ===== */
async function init(round){
  ROUND = round;
  document.getElementById('thRoundRank').textContent = `Round ${ROUND} Ranking`;

  const sel = document.getElementById('roundSelect');
  if (sel.value !== String(ROUND)) sel.value = String(ROUND);
  const url = new URL(location.href);
  url.searchParams.set('round', String(ROUND));
  history.replaceState(null, '', url);

  try{
    setStatus('Loading data…');
    document.getElementById('ladder').style.display = 'none';
    document.getElementById('status').style.display = '';

    const roundKey = `ScoresRound${ROUND}`;
    const [playersRaw, scoresRawAll, scheduleRaw, datesRaw] = await Promise.all([
      loadCSV(CSV.Players),
      loadCSV(CSV[roundKey]),
      loadCSV(CSV.Schedule),
      loadCSV(CSV.Dates)
    ]);

    const phoneByName = {};
    (playersRaw||[]).forEach(r=>{
      const nm = fmt(r.Participant);
      const ph = fmt(r.PHONE || r.Phone || r.phone);
      if (nm) phoneByName[nameKey(nm)] = ph;
    });

    const roundRow = (datesRaw||[]).find(r => Number(r.Round) === Number(ROUND));
    if (roundRow){
      const span = fmtDateRange(roundRow.Start, roundRow.End);
      const type = fmt(roundRow.Type);
      const meta = document.getElementById('roundMeta');
      meta.textContent = '';
      const a = document.createElement('span'); a.textContent = span || ''; meta.appendChild(a);
      if (type){ const dot = document.createElement('span'); dot.className = 'dot'; dot.textContent = type; meta.appendChild(dot); }
    }

    const activePlayersRaw = (playersRaw||[]).filter(r => {
      const start = num(r.RStart), end = num(r.REnd), rr = Number(ROUND);
      return (isNaN(start) || start <= rr) && (isNaN(end) || end >= rr);
    });

    // current standings (unchanged logic)
    const currentPlayers = activePlayersRaw.map(r => ({
      Participant: fmt(r.Participant),
      CurrPts: num(r.R8Pts),
      CurrPerc: num(r.R8Perc),
    })).sort((a,b)=>{
      const pA = isNaN(a.CurrPts)?-Infinity:a.CurrPts, pB = isNaN(b.CurrPts)?-Infinity:b.CurrPts;
      if (pA !== pB) return pB - pA;
      const qA = isNaN(a.CurrPerc)?-Infinity:a.CurrPerc, qB = isNaN(b.CurrPerc)?-Infinity:b.CurrPerc;
      if (qA !== qB) return qB - qA;
      return a.Participant.localeCompare(b.Participant, undefined, {sensitivity:'base'});
    });
    const currentRankByName = {};
    currentPlayers.forEach((p,i)=> currentRankByName[nameKey(p.Participant)] = i+1);
    const currentByName = {};
    currentPlayers.forEach(p => currentByName[nameKey(p.Participant)] = p);

    // beginning-of-round standings
    const ptsLabel  = `R${ROUND}Pts`;
    const percLabel = `R${ROUND}Perc`;
    const beginPlayers = activePlayersRaw.map(r => ({
      Participant: fmt(r.Participant),
      BeginPts: num(r[ptsLabel]),
      BeginPerc: num(r[percLabel]),
    })).sort((a,b)=>{
      const pA = isNaN(a.BeginPts)?-Infinity:a.BeginPts, pB = isNaN(b.BeginPts)?-Infinity:b.BeginPts;
      if (pA !== pB) return pB - pA;
      const qA = isNaN(a.BeginPerc)?-Infinity:a.BeginPerc, qB = isNaN(b.BeginPerc)?-Infinity:b.BeginPerc;
      if (qA !== qB) return qB - qA;
      return a.Participant.localeCompare(b.Participant, undefined, {sensitivity:'base'});
    });

    const beginRankByName = {}, nameByBeginRank = {};
    beginPlayers.forEach((p,i)=>{ p.BeginRank=i+1; beginRankByName[nameKey(p.Participant)]=p.BeginRank; nameByBeginRank[p.BeginRank]=p.Participant; });

    // scheduled opponent mapping by begin-rank
    const scheduleCol = `Round ${ROUND}`;
    const scheduleMap = {};
    (scheduleRaw||[]).forEach(r=>{
      const rnk = Number(r.Ranking), opp = Number(r[scheduleCol]);
      if (!isNaN(rnk) && !isNaN(opp)) scheduleMap[rnk] = opp;
    });

    // scores for this round
    const scoresRaw = (scoresRawAll||[]).filter(r => {
      const rr = Number(r.Round);
      return isNaN(rr) || rr === Number(ROUND);
    });

    const scheduled = new Map();     // key -> matchObj
    const challenges = new Map();    // key -> [matchObj, matchObj]
    function pushChallenge(key, matchObj){
      const arr = challenges.get(key) || [];
      if (arr.length < 2) { arr.push(matchObj); challenges.set(key, arr); }
    }

    scoresRaw.forEach(r=>{
      const type = String(r.MatchType||'').trim();
      if (type !== 'Scheduled' && type !== 'Challenge') return;

      const winner = fmt(r.Winner), opponent = fmt(r.Opponent);
      const wKey = nameKey(winner), oKey = nameKey(opponent);
      const wRank = beginRankByName[wKey], oRank = beginRankByName[oKey];

      const { wGames, oGames, diff } = parseGameTotals(r);
      const upset = String(r.Upset||'').toUpperCase() === 'YES' ? 'YES' : 'NO';

      const winObj = {
        text: resultString(r,'winner', beginRankByName), isLoss:false, row:r,
        wRank, oRank, upset, type, gw:wGames, gl:oGames, gdiff:diff
      };
      const loseObj = {
        text: resultString(r,'opponent', beginRankByName), isLoss:true, row:r,
        wRank:oRank, oRank:wRank, upset:'NO', type, gw:oGames, gl:wGames,
        gdiff:Math.max(0,oGames - wGames)
      };

      if (type === 'Scheduled'){
        scheduled.set(wKey, winObj);
        scheduled.set(oKey, loseObj);
      } else {
        pushChallenge(wKey, winObj);
        pushChallenge(oKey, loseObj);
      }
    });

    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';

    function makeParticipantCell(playerName, beginRank){
      const wrap = document.createElement('div');

      // Mobile: "#X  Name" on one line
      const mHead = document.createElement('div');
      mHead.className = 'm-head';
      const mRank = document.createElement('span');
      mRank.className = 'm-rank';
      mRank.textContent = `#${beginRank}`;
      const mName = document.createElement('span');
      mName.className = 'm-name';
      mName.textContent = playerName || '';
      mHead.appendChild(mRank);
      mHead.appendChild(mName);
      wrap.appendChild(mHead);

      // Desktop: name line
      const nameEl = document.createElement('div');
      nameEl.className = 'name';
      nameEl.textContent = playerName || '';
      wrap.appendChild(nameEl);

      // Phone line
      const ph = phoneByName[nameKey(playerName)] || '';
      const phoneEl = document.createElement('span');
      phoneEl.className = 'phone';
      phoneEl.textContent = ph ? ph : '(no phone)';
      wrap.appendChild(phoneEl);

      return wrap;
    }

    function appendPointsButton(container, matchObj, isChallenge, hasScheduledPlayed){
      const r = matchObj.row;
      if (matchObj.isLoss){
        const baseGames = matchObj.gw;
        const base = ('LosePoints' in r) ? safeNum(r.LosePoints) : Math.min(10, baseGames);
        const divisor = isChallenge ? (hasScheduledPlayed ? 2 : 4) : 1;
        const final = isChallenge ? Math.round(base / divisor) : base;

        const btn = document.createElement('button');
        btn.type='button'; btn.className='loser-pts';
        btn.setAttribute('data-role','loser');
        btn.setAttribute('data-points', String(final));
        btn.setAttribute('data-gameswon', String(baseGames));
        btn.setAttribute('data-chaldiv', String(isChallenge ? divisor : ''));
        btn.innerHTML = `<b>${final}</b> pts`;
        container.appendChild(btn);
      } else {
        const base = ('WinPoints' in r) ? safeNum(r.WinPoints)
                                       : (matchObj.upset==='YES'
                                          ? Math.max(15, Math.min(25, Math.round(10 + matchObj.gdiff * ((matchObj.wRank - matchObj.oRank)/2))))
                                          : Math.max(11, Math.round(10 + matchObj.gdiff)));
        const divisor = isChallenge ? (hasScheduledPlayed ? 2 : 4) : 1;
        const final = isChallenge ? Math.round(base / divisor) : base;

        const btn = document.createElement('button');
        btn.type='button'; btn.className='winner-pts';
        btn.setAttribute('data-role','winner');
        btn.setAttribute('data-points', String(final));
        btn.setAttribute('data-upset', matchObj.upset);
        btn.setAttribute('data-gw', String(matchObj.gw));
        btn.setAttribute('data-gl', String(matchObj.gl));
        btn.setAttribute('data-gdiff', String(matchObj.gdiff));
        btn.setAttribute('data-wrank', String(matchObj.wRank||''));
        btn.setAttribute('data-orank', String(matchObj.oRank||''));
        btn.setAttribute('data-chaldiv', String(isChallenge ? divisor : ''));
        btn.innerHTML = `<b>${final}</b> pts`;
        container.appendChild(btn);
      }
    }

    beginPlayers.forEach((bp, idx)=>{
      const tr = document.createElement('tr');

      const meKey = nameKey(bp.Participant);
      const beginRank = idx + 1;
      const currentRank = currentRankByName[meKey] || '';
      const cp = currentByName[meKey];
      const currPts = (cp && !isNaN(cp.CurrPts)) ? cp.CurrPts : '';

      // Column 1: Round # Ranking (desktop)
      const tdBegin = document.createElement('td');
      tdBegin.className = 'rank rank-begin';
      tdBegin.textContent = `#${beginRank}`;
      tr.appendChild(tdBegin);

      // Column 2: Participant
      const tdName = document.createElement('td');
      tdName.appendChild(makeParticipantCell(bp.Participant, beginRank));
      tr.appendChild(tdName);

      // Column 3: Result
      const tdRes = document.createElement('td');
      tdRes.className = 'matches';

      const hasScheduledPlayed = scheduled.has(meKey);

      // row 1: scheduled
      const schedLine = document.createElement('div');
      schedLine.className = 'match-line';
      const sr = scheduled.get(meKey);

      if (sr){
        const pill = document.createElement('span'); pill.className='badge badge-scheduled'; pill.textContent='Scheduled';
        schedLine.appendChild(pill);

        const span = document.createElement('span'); span.className='result ' + (sr.isLoss ? 'lost' : 'won'); span.textContent=sr.text;
        schedLine.appendChild(span);

        appendPointsButton(schedLine, sr, false, hasScheduledPlayed);
      } else {
        const oppRank = scheduleMap[beginRank];
        if (oppRank){
          const oppName = nameByBeginRank[oppRank] || '';

          const pill = document.createElement('span'); pill.className='badge badge-scheduled'; pill.textContent='Scheduled';
          schedLine.appendChild(pill);

          const pre = document.createElement('span');
          pre.textContent = `#${oppRank} ${oppName}`;
          schedLine.appendChild(pre);
        } else {
          schedLine.classList.add('empty');
          schedLine.innerHTML = '&nbsp;';
        }
      }
      tdRes.appendChild(schedLine);

      // challenges
      const myChals = challenges.get(meKey) || [];
      for (let i=0; i<2; i++){
        const line = document.createElement('div');
        line.className = 'match-line';

        const cr = myChals[i];
        if (cr){
          const pill = document.createElement('span'); pill.className='badge badge-challenge'; pill.textContent='Challenge';
          line.appendChild(pill);

          const span = document.createElement('span'); span.className='result ' + (cr.isLoss ? 'lost' : 'won'); span.textContent=cr.text;
          line.appendChild(span);

          appendPointsButton(line, cr, true, hasScheduledPlayed);
        } else {
          line.classList.add('empty');
          line.innerHTML = '&nbsp;';
        }
        tdRes.appendChild(line);
      }

      // Mobile-only: "Points: ##   Current Rank: ##" (one line)
      const mStats = document.createElement('div');
      mStats.className = 'm-stats';
      const ptsText = (currPts !== '' && currPts !== null && currPts !== undefined) ? String(currPts) : '—';
      const crText  = currentRank ? `#${currentRank}` : '—';
      mStats.innerHTML = `Points: <b>${ptsText}</b> &nbsp;&nbsp; Current Rank: <b>${crText}</b>`;
      tdRes.appendChild(mStats);

      tr.appendChild(tdRes);

      // Column 4: Points (desktop)
      const tdPts = document.createElement('td');
      tdPts.className = 'points';
      tdPts.textContent = (cp && !isNaN(cp.CurrPts)) ? cp.CurrPts : '';
      tr.appendChild(tdPts);

      // Column 5: Current Ranking (desktop)
      const tdCurr = document.createElement('td');
      tdCurr.className = 'rank current rank-current';
      tdCurr.textContent = currentRank ? `#${currentRank}` : '';
      tr.appendChild(tdCurr);

      tbody.appendChild(tr);
    });

    document.getElementById('ladder').style.display = '';
    document.getElementById('status').style.display = 'none';
    setStatus('');
  }catch(err){
    console.error(err);
    setStatus('There was a problem loading your data. Double-check the CSV links and headers.', true);
  }
}

/* Round select */
function buildRoundSelect(){
  const sel = document.getElementById('roundSelect');
  sel.innerHTML = '';
  for (let r=1; r<=CurrentRound; r++){
    const opt = document.createElement('option');
    opt.value = String(r);
    opt.textContent = `Round ${r}`;
    sel.appendChild(opt);
  }
  sel.value = String(ROUND);
  sel.addEventListener('change', () => {
    const r = parseInt(sel.value,10);
    if (!isNaN(r) && r>=1 && r<=CurrentRound) init(r);
  });
}

/* ===== Points modal handler ===== */
function handlePointsClick(e){
  const loserBtn  = e.target.closest('.loser-pts');
  const winnerBtn = e.target.closest('.winner-pts');
  if (!loserBtn && !winnerBtn) return;

  e.preventDefault();
  e.stopPropagation();

  if (loserBtn){
    const pts  = loserBtn.getAttribute('data-points') || '';
    const gw   = loserBtn.getAttribute('data-gameswon') || '0';
    const div  = loserBtn.getAttribute('data-chaldiv') || '';
    const isChallenge = div && div !== '' && div !== '1';

    const html = `
      <p><strong>Total number of games won:</strong> ${gw}</p>
      <p><strong>Points awarded:</strong> ${pts}</p>
      ${isChallenge ? `
        <p><strong>Challenge divider:</strong> ${div}</p>
        <p class="tip">Divided by 2 when scheduled match is played; divided by 4 when scheduled match is not played.</p>
      ` : ``}
      <p class="tip">Losers receive the number of games won, but no more than 10.</p>
    `;
    openModal('Loser Points', html);
    return;
  }

  if (winnerBtn){
    const pts   = winnerBtn.getAttribute('data-points') || '';
    const upset = (winnerBtn.getAttribute('data-upset') || 'NO').toUpperCase();
    const gw    = winnerBtn.getAttribute('data-gw') || '0';
    const gl    = winnerBtn.getAttribute('data-gl') || '0';
    const gd    = winnerBtn.getAttribute('data-gdiff') || '0';
    const wr    = winnerBtn.getAttribute('data-wrank') || '';
    const orr   = winnerBtn.getAttribute('data-orank') || '';
    const rdiff = (wr && orr) ? Math.abs(Number(wr)-Number(orr)) : '';
    const div   = winnerBtn.getAttribute('data-chaldiv') || '';
    const isChallenge = div && div !== '' && div !== '1';
    const topAlert = (upset === 'YES') ? `<p><strong>UPSET ALERT!</strong></p>` : ``;

    const body = (upset === 'YES')
      ? `
          <p><strong>Games won:</strong> ${gw}, <strong>Games lost:</strong> ${gl}, <strong>Difference in games:</strong> ${gd}</p>
          <p><strong>Rank:</strong> ${wr}, <strong>Opponent Rank:</strong> ${orr}, <strong>Difference in rank:</strong> ${rdiff}</p>
          <p><strong>Points awarded:</strong> ${pts}</p>
          ${isChallenge ? `
            <p><strong>Challenge divider:</strong> ${div}</p>
            <p class="tip">Divided by 2 when scheduled match is played; divided by 4 when scheduled match is not played.</p>
          ` : ``}
          <p class="tip">Upset winners receive 10 + (difference in games won/lost × difference in ranking / 2), minimum 15, maximum 25.</p>
        `
      : `
          <p><strong>Games won:</strong> ${gw}, <strong>Games lost:</strong> ${gl}, <strong>Difference:</strong> ${gd}</p>
          <p><strong>Points awarded:</strong> ${pts}</p>
          ${isChallenge ? `
            <p><strong>Challenge divider:</strong> ${div}</p>
            <p class="tip">Divided by 2 when scheduled match is played; divided by 4 when scheduled match is not played.</p>
          ` : ``}
          <p class="tip">Winners receive 10 + (difference in games won/lost), minimum 11.</p>
        `;
    openModal('Winner Points', `${topAlert}${body}`);
  }
}

document.addEventListener('click', handlePointsClick, { capture:false });
document.addEventListener('pointerup', handlePointsClick, { capture:false });

/* Boot */
buildRoundSelect();
init(ROUND);
</script>
</body>
</html>
